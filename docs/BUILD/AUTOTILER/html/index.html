<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>GAP8 Auto-tiler Manual</title>
<title>GAP8 Auto-tiler Manual</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="pulp.css" rel="stylesheet" type="text/css" />
<link href="gap.css" rel="stylesheet" type="text/css" />
<link href="images.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="titlerow">
  <td id="projectlogo"><img alt="Logo" src="gap-logo-55.png" /></td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">Auto Tiler Library</div>
    </td>
  <td id="extralogo"><img alt="GreenWaves" src="greenwaves-logo-55.png" /></td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">GAP8 Auto-tiler Manual </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section0"></a>
Introduction</h1>
<p>The Auto-tiler is a tool that runs on users PCs before GAP8 code compilation and automatically generates GAP8 code for memory tiling and transfers between all memory levels: GAP8 has two levels in-chip memory (L1 and L2) and an external optional 3rd level (L3).</p>
<p>From a user perspective, the purpose of the auto-tiler is twofold:</p>
<ol type="1">
<li>Use the generators provided in the GAP8 SDK which contains several ready to go optimized algorithms like CNN layers, sound and image processing.</li>
<li>Create new generators with your own algorithms.</li>
</ol>
<p>For several of the use cases the former will be enough to build your own application.</p>
<h1><a class="anchor" id="section1"></a>
Use generators provided within the SDK</h1>
<p>To exploit generators provided in the sdk, all the user needs to do is to write his own model.</p>
<div class="image">
<img src="images/tiler_structure.png"/>
</div>
<p>In the SDK we provide several examples on how to write your own model:</p>
<div class="fragment"><div class="line">$ cd  $GAP_SDK_HOME/examples/pulp-examples/autotiler_examples/</div></div><!-- fragment --><p><a href="https://github.com/GreenWaves-Technologies/gap_sdk/tree/master/examples/pulp-examples/autotiler_examples">Here you can browse them on github.</a></p>
<p>Here is a list of generators provided within the SDK:</p>
<ul>
<li>Convolutional Neural Network Layers<ul>
<li>2D convolution (FP8 and FP16)</li>
<li>Relu Activation (FP8 and FP16)</li>
<li>Max and Average Pooling (FP8 and FP16)</li>
<li>Addition (FP8 and FP16)</li>
</ul>
</li>
<li>2D Fast Fourier Transform</li>
<li>FIR Filtering</li>
<li>Integral Image</li>
<li>Image Resize</li>
<li>Matrix Addition and Multiplication</li>
</ul>
<p>All the generators source code can be found here:</p>
<div class="fragment"><div class="line">$ cd  $GAP_SDK_HOME/tools/autotiler/generators</div></div><!-- fragment --><p> <a href="https://github.com/GreenWaves-Technologies/autotiler/tree/master/generators">You can browse it here on github.</a></p>
<h1><a class="anchor" id="section2"></a>
Create your own generators aka the complete auto-tiler guide</h1>
<p>If you want to extend the generators suite that we provide in our SDK in this paragraph we explain all the auto-tiler fundamentals.</p>
<h2><a class="anchor" id="section3"></a>
GAP8's memory hierarchy</h2>
<p>GAP8's memory hierarchy is made up of three levels:</p>
<ol type="1">
<li>Shared level 1 memory Internal and tightly coupled with GAP8 cluster, it can deliver up to 8 parallel memory accesses in a single cycle. This is by far GAP8's fastest memory and has the highest bandwidth. As it is quite costly, its size has had to be kept relatively small, 64 Kbytes in the current configuration.</li>
<li>Level 2 memory Internal memory significantly larger than level 1, but with higher access latency (approximately 6 cycles) and lower bandwidth. Its primary role is to store programs that are then fetched by the different instruction caches attached to GAP8's various cores and to store relatively large data structures. In the current version its size is 512 Kbytes.</li>
<li>Level 3 memory External and optional (in the case of RAM). It is either read only (Flash) or read/write (RAM). Read only memory is mapped onto either the quad-SPI or HyperBus interfaces. Read/write memory is mapped onto the HyperBus interface. The latency, the access time and the bandwidth is even more limited than the other 2 memory areas and importantly accesses to level 3 memory consume more energy.</li>
</ol>
<p>There are two DMA units. The micro-DMA unit, responsible for transfers to and from peripherals into the level 2 memory and the cluster-DMA unit, which can be used to schedule unattended transfers between level 2 and level 1 memory.</p>
<p>The level 1 and level 2 memories are also directly accessible by all the cores in the chip.</p>
<p>To keep the size of the chip as small as possible and to reduce the amount of energy spent in memory accesses GAP8 does not use data caching. Level 3 memory is the most constrained since data must be moved into the chip level 2 memory with the micro-DMA unit (streaming).</p>
<h2><a class="anchor" id="section4"></a>
Auto-tiler architecture</h2>
<p>The ideal memory model for a developer is to view memory as one large continuous area that is as big and as fast as possible. This is normally achieved by a data cache which automatically moves data between memory areas. Since GAP8 does not implement data caching and since GAP8's cluster is optimized for processing data in a linear or piece-wise linear fashion, we provide a software tool, the GAP8 auto-tiler, to help the developer by automating memory movements for programs of this type.</p>
<p>The auto-tiler uses defined patterns of data access to anticipate data movements ensuring that the right data is available in level 1 memory when needed. Since GAP8's cluster-DMA and micro-DMA units operate in parallel with all the GAP8 cores, the auto-tiler can use these units to make these pipelined memory transfers quasi-invisible from a performance point of view. The auto-tiler decomposes 1, 2, 3 and 4-dimensional data structures into a set of tiles (2-dimensional structures) and generates the C code necessary to move these tiles in and out of shared level 1 memory. The developer concentrates on the code that handles simple 2D tiles and the auto-tiler takes care of moving tiles into and out of level 1 memory as necessary and calling the developer's code.</p>
<p>Below is a list of the entities that make up the configuration or data model necessary for the GAP8 auto-tiler to generate functioning code. We refer extensively to a 'model' which is used to indicate the use of the auto-tiler API to declare the signature of developer functions (basic kernels) and define iterated assemblies of basic kernels which actually cause the auto-tiler to generate code.</p>
<ol type="1">
<li>Basic kernels Pure C functions, these are written by the developer as if all the data structures they access can fit into shared level 1 memory (data tiles). Basic kernels can also use arguments that are prepositioned in memory (not tiled). Basic kernel functions are modeled, their call template formally described, by basic kernel models. This allows the GAP8 auto-tiler to generate code that calls them. They are described in detail in the section [Basic kernels].</li>
<li><p class="startli">User kernels User kernel models group calls to basic kernels and allow the GAP8 auto-tiler to generate a C function for that grouping. A user kernel defines the different, predefined ways in which of 2, 3 or 4-dimensional data is traversed, and one or more basic kernels are called. A user kernel model takes arguments that describe the input, working and output data that needs to be modeled.</p>
<p class="startli">User kernels consume and process data through these user kernel arguments. Kernel argument models describe argument location in the memory hierarchy (level 3, level 2 or level 1), direction (in, out, in out, pure buffer), inner dimension (width and height), dimensionality (1D, 2D, 3D, 4D). Kernel argument models include several other attributes that are used to constrain the tiles that are generated from the argument (preferred size, odd/even size, etc.) or to provide hints that control the double or triple-buffering strategy used in the generated code. Calls to basic kernels can be inserted in different places in the generated iterative code (inner loop, loop prologue, loop epilogue, etc.). The calls are bound to arguments which can either be from the kernel argument model described above, direct C arguments or immediates. User kernels are described in detail in the section [User kernels].</p>
</li>
<li>User kernel groups User kernel groups are models that combines or groups several user kernels together in a given order. A C function is generated from the user kernel group whose body contains calls to the sequence of user kernels with proper argument bindings between them. User kernel groups are described in detail in the section [User kernel groups].</li>
<li>Model control Model control contains configuration elements such as available memory, compilation hints, consumed and produced files, basic kernels loaded as libraries and an ordered list of user kernels and/or user kernel groups. Model control is described in the section [Controlling tiled code generation].</li>
</ol>
<p>The auto-tiler model is created through a series of calls to functions from the auto-tiler library. In addition to these calls, the developer can add whatever application specific code needed. Compiling and running the model on the build system creates a set of C source files that are then compiled and run on GAP8.</p>
<p>The basic object on which the GAP8 auto-tiler works is a 2D space that we call a data plane. Each user kernel argument corresponds to a data plane and potentially each user kernel argument can have a different width and height. For example, if the kernel we want to write produces one output for each 2x2 input sub region the input argument will be a data plane of WxH in size and the output argument will be a data plane of size (W/2)x(H/2).</p>
<p>This basic data plane can then be extended to 3 or 4 dimensions. Extending the dimension of a data plane is simply a repletion of the 2-dimensional basic data plane.</p>
<p>The GAP8 auto-tiler splits basic data planes into tiles, the number of tiles for each user kernel argument is identical but their dimension can vary from one argument to the other.</p>
<p>The GAP8 auto-tiler makes the following hypothesis about the user algorithm:</p>
<div class="fragment"><div class="line">OutputDataPlane = Kernel(InputDataPlane1, InputDataPlane2, ...)</div></div><!-- fragment --><p>Which can be rewritten as:</p>
<div class="fragment"><div class="line">For i in [0..NumberOfTiles-1]</div><div class="line">  Tile(OutputDataPlane, i) =</div><div class="line">    Kernel(Tile(InputDataPlane1, i), Tile(InputDataPlane2, i), ...)</div></div><!-- fragment --><p>Not all algorithms fits into this template but we believe it captures a large family of useful algorithms.</p>
<p>The illustrative examples below show how an entire auto-tiler model is constructed. Don't worry if they are confusing at the start. As you read the other sections of the manual the examples should become clear.</p>
<h3><a class="anchor" id="section5"></a>
Illustrative example 1 - Matrix addition</h3>
<p>In this example, we want to add two integer matrices and store the result in a third matrix.</p>
<p>You can see the full code for the example in autotiler/examples/MatrixAdd</p>
<p>The basic kernel that does the job of addition is MatSumPar. It takes arguments of pointers to two input tiles and one output tile, these three tiles are expected to have the same dimensions which are passed as W and H. It is expected that the 3 matrices fit into shared level 1 memory.</p>
<p>The basic kernel for this example is shown in the basic kernel section below.</p>
<p>We first model the template of basic kernel MatSumPar function call.</p>
<div class="fragment"><div class="line"><a class="code" href="group__BasicK.html#ga063761c92b60c97b3d9ab7cf86c75567">LibKernel</a>(<span class="stringliteral">&quot;MatSumPar&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#ggac8ad19c11fd96ccc1286845c0048d584ab7f7e0d8ffdbbdbb19983c00561c0f83">CALL_PARALLEL</a>,</div><div class="line">  <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(5,</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In1&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In2&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>, <span class="stringliteral">&quot;W&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>, <span class="stringliteral">&quot;H&quot;</span>)</div><div class="line">  ),</div><div class="line">  <span class="stringliteral">&quot;MatrixAdd_Arg_T&quot;</span></div><div class="line">);</div></div><!-- fragment --><p>And then we model a user kernel generator with no restrictions on the matrices dimensions (of course they need to fit into the level 2 memory). This describes the input and output parameters of the generated function and the way that the data is iterated.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MatAddGenerator(<span class="keywordtype">char</span> *UserKernelName, <span class="keywordtype">int</span> W, <span class="keywordtype">int</span> H)</div></div><!-- fragment --><p>During our build process the generator code is compiled and <code>MatAddGenerator("MatAdd", 200, 300)</code> is called. The GAP8 auto-tiler generates the following code:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MatAdd(</div><div class="line">  Word32 * __restrict__ In1,</div><div class="line">  Word32 * __restrict__ In2,</div><div class="line">  Word32 * __restrict__ Out,</div><div class="line">  <a class="code" href="structKernel__T.html">Kernel_T</a> *Ker)</div><div class="line"></div><div class="line">{</div><div class="line">  <span class="comment">/* Local variables used by this kernel */</span></div><div class="line">  <span class="keywordtype">int</span> DmaR_Evt1;</div><div class="line">  <span class="keywordtype">int</span> DmaR_Evt2;</div><div class="line">  <span class="keywordtype">int</span> DmaW_Evt1;</div><div class="line">  <span class="keywordtype">int</span> Iter, Last, NextLast, NextNextLast, InPlane, OutPlane=0;</div><div class="line">  <span class="keywordtype">int</span> N_Ti = 0, N_TiIp = 0;</div><div class="line">  <a class="code" href="structMatrixAdd__Arg__T.html">MatrixAdd_Arg_T</a> S_KerArg0, *KerArg0 = &amp;S_KerArg0;</div><div class="line"></div><div class="line">  <span class="comment">/* Initialize KerArg, Kernel invariant arguments */</span></div><div class="line">  KerArg0-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#a4d088ab1417414e2a21fbcdf600ee109">W</a> = (<span class="keywordtype">unsigned</span> int) (200);</div><div class="line">  KerArg0-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#ab0d9729345982dcc92fcff8ec66cf0c9">H</a> = (<span class="keywordtype">unsigned</span> int) (10);</div><div class="line">  <span class="comment">/* ================Read First Tile================ */</span></div><div class="line">  <span class="comment">/* Initial reads in L2, O_DB or O_BUFF */</span></div><div class="line">  DmaR_Evt1 =  gap8_dma_memcpy((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) In1+(0),</div><div class="line">        (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 0)+0, 8000, DMA_COPY_IN);</div><div class="line">  DmaR_Evt2 =  gap8_dma_memcpy((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) In2+(0),</div><div class="line">        (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 16000)+0, 8000, DMA_COPY_IN);</div><div class="line">  <span class="comment">/* ================End Read First Tile================ */</span></div><div class="line">  <span class="comment">/* Kernel Iteration Loop on tiled inner space */</span></div><div class="line">  <span class="keywordflow">for</span> (Iter=0; Iter&lt;30; Iter++) {</div><div class="line">    <span class="comment">/* Loop Iteration Body on tiled inner space */</span></div><div class="line">    <span class="comment">/* Elaborate Last, Next_Last, Next_Next_Last */</span></div><div class="line">    Last = ((Iter+1) == 30);</div><div class="line">    NextLast = ((Iter+2) == 30);</div><div class="line">    NextNextLast = ((Iter+3) == 30);</div><div class="line">    <span class="comment">/* ================Read Next Tile================ */</span></div><div class="line">    gap8_dma_wait(DmaR_Evt1);</div><div class="line">    gap8_dma_wait(DmaR_Evt2);</div><div class="line">    <span class="keywordflow">if</span> (!Last) {</div><div class="line">      DmaR_Evt1 =  gap8_dma_memcpy((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) In1 + ((Iter+1)*8000),</div><div class="line">          (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 0) + 8000*((N_Ti+1) % 2), 8000, DMA_COPY_IN);</div><div class="line">      DmaR_Evt2 =  gap8_dma_memcpy((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) In2 + ((Iter+1)*8000),</div><div class="line">          (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 16000) + 8000*((N_Ti+1) % 2), 8000, DMA_COPY_IN);</div><div class="line">    }</div><div class="line">    <span class="comment">/* ================End Read Next Tile================ */</span></div><div class="line">    <span class="comment">/* Call Kernel LOC_INNER_LOOP */</span></div><div class="line">    KerArg0-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#afa74ff0a06e1fd36593784e9a9e0ab74">In1</a> = (Word32 * __restrict__)</div><div class="line">      ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 0) + 8000*(N_Ti % 2));</div><div class="line">    KerArg0-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#a1665d591230d89cc24c5a435c71165ed">In2</a> = (Word32 * __restrict__)</div><div class="line">      ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 16000) + 8000*(N_Ti % 2));</div><div class="line">    KerArg0-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#a6eb919d3c3bd426a9d5b38202c1213cd">Out</a> = (Word32 * __restrict__)</div><div class="line">      ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 32000) + 8000*(N_Ti % 2));</div><div class="line">    gap8_task_dispatch((1&lt;&lt;gap8_ncore())-1, MatrixAdd, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) KerArg0);</div><div class="line">    MatrixAdd(KerArg0);</div><div class="line">    <span class="comment">/* ================Write Tile================ */</span></div><div class="line">    <span class="keywordflow">if</span> (Iter) {</div><div class="line">      gap8_dma_wait(DmaW_Evt1);</div><div class="line">    }</div><div class="line">    DmaW_Evt1 =  gap8_dma_memcpy((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) Out + ((Iter)*8000),</div><div class="line">      (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 32000) + 8000*(N_Ti % 2), 8000, DMA_COPY_OUT);</div><div class="line">    <span class="comment">/* ================End Write Tile================ */</span></div><div class="line">    N_Ti++;</div><div class="line">    <span class="comment">/* End Kernel Iteration Loop on tiled inner space */</span></div><div class="line">  }</div><div class="line">  Iter=30;</div><div class="line">  <span class="comment">/* ================Write Last Tile================ */</span></div><div class="line">  gap8_dma_wait(DmaW_Evt1);</div><div class="line">  <span class="comment">/* ================End Write Last Tile================ */</span></div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="section6"></a>
Illustrative example 2 - Searching the maximum in a 2D matrix</h3>
<p>This user kernel also operates on a 2D integer matrix but returns the maximum value in this matrix. Here we model a classic parallel map/reduce algorithm to accomplish the task. We use a basic kernel, <code>KerMatrixMax</code>, which operates on a tile. <code>KerMatrixMax</code> takes as arguments: a pointer to a tile <code>In</code>, the dimensions of this tile (<code>W</code> and <code>H</code>), a pointer to the vector <code>Out</code> (a buffer whose dimension is the number of tiles) to store the max for each tile. <code>KerMatrixMax</code> also takes an argument <code>CompareWithOut</code>, which indicates if a valid maximum is already available in the output vector and should be compared against the maximum calculated in the current tile.</p>
<p>Each basic kernel call will return the maximum in a sub section of the full input matrix. To get the final result we have to reduce the set of sub-results into a single result. This is our second kernel: <code>KerMatrixMaxReduction</code>. As a first argument <code>In</code> it takes the vector of maximums produced by the first basic kernel as well as its dimension <code>Ntile</code>. It produces a pointer to a single maximum in <code>Out</code> (a 1 x 1 tile). It should be executed when we are done with all the tiles so the call is inserted in the inner space iterator prologue (see the user model below).</p>
<p>The 2 basic kernels are first modeled.</p>
<div class="fragment"><div class="line"><a class="code" href="group__BasicK.html#ga063761c92b60c97b3d9ab7cf86c75567">LibKernel</a>(<span class="stringliteral">&quot;KerMatrixMax&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#ggac8ad19c11fd96ccc1286845c0048d584ab7f7e0d8ffdbbdbb19983c00561c0f83">CALL_PARALLEL</a>,      <span class="comment">// A parallel call</span></div><div class="line">  <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(6,</div><div class="line">    <span class="comment">// A tile</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In&quot;</span>),   </div><div class="line">    <span class="comment">// A vector of maximums</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),  </div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>, <span class="stringliteral">&quot;W&quot;</span>),     <span class="comment">// Tile width</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>, <span class="stringliteral">&quot;H&quot;</span>),     <span class="comment">// Tile Height</span></div><div class="line">    <span class="comment">// Which Tile - index into Out for result</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>, <span class="stringliteral">&quot;TileIndex&quot;</span>),   </div><div class="line">    <span class="comment">// Out[TileIndex] contains a Max</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>, <span class="stringliteral">&quot;CompareWithOut&quot;</span>)</div><div class="line">  ),</div><div class="line">  <span class="stringliteral">&quot;MatrixMax_Arg_T&quot;</span></div><div class="line">);</div><div class="line"><a class="code" href="group__BasicK.html#ga063761c92b60c97b3d9ab7cf86c75567">LibKernel</a>(<span class="stringliteral">&quot;KerMatrixMaxReduction&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#ggac8ad19c11fd96ccc1286845c0048d584a6a3dd38f3ae3e431987a5a50003c866b">CALL_SEQUENTIAL</a>,   <span class="comment">// A sequential call</span></div><div class="line">  <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(3,</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In&quot;</span>),   <span class="comment">// A vector of Maximums</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),  <span class="comment">// Pointer to the unique Maximum</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>, <span class="stringliteral">&quot;Ntile&quot;</span>)    <span class="comment">// Number of entries into In</span></div><div class="line">  ),</div><div class="line">  <span class="stringliteral">&quot;MatrixMaxReduction_Arg_T&quot;</span></div><div class="line">);</div></div><!-- fragment --><p>Then the Matrix Max user kernel generator:</p>
<div class="fragment"><div class="line"><span class="comment">/* A user kernel generator computing the max of a 2D plain matrix of size WxH */</span></div><div class="line"><span class="keywordtype">void</span> MatrixMax(<span class="keywordtype">char</span> *Name, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> W, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> H)</div><div class="line"></div><div class="line">{</div><div class="line">  <a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(Name,</div><div class="line">    <span class="comment">// Dimension is WxH</span></div><div class="line">    KernelDimensions(1, W, H, 1),</div><div class="line">    <span class="comment">// 2D iteration space</span></div><div class="line">    KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4ca82ed5e72b32c8ab2049c97335bf47146">KER_DIM2</a>, KER_TILE),</div><div class="line">    <span class="comment">// Tile horizontally</span></div><div class="line">    <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258a42bffded6e7107d8c7f2570b28748ba5">TILE_HOR</a>,</div><div class="line">    <span class="comment">// User kernel C template</span></div><div class="line">    <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(2,</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;int * __restrict__&quot;</span>, <span class="stringliteral">&quot;In&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;int * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>)</div><div class="line">    ),</div><div class="line">    <span class="comment">// 2 calls to basic kernels</span></div><div class="line">    <a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(2,</div><div class="line">      <span class="comment">// First KerMatrixMax in the inner iterator</span></div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;KerMatrixMax&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(6,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>), <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;TiledOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>), <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adafe4f90e1c50b05c7554fc7a2dfe4ee58">KER_ARG_TILEINDEX</a>), <a class="code" href="group__ArgBind.html#ga02e73d15bc6b3fb0d066738073dbc441">Imm</a>(0))</div><div class="line">        ),</div><div class="line">      <span class="comment">// Second  KerMatrixMaxReduction after we have consumed all tiles.</span></div><div class="line">      <span class="comment">// Final result goes directly to *Out thanks to C_Arg(&quot;Out&quot;)</span></div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;KerMatrixMaxReduction&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gaeb36d40437f7d6748903949d2942fece">LOC_INNER_LOOP_EPILOG</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(3,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;TiledOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaf6edaa719b6437891903d3d53700e4c0">KER_ARG</a>), <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;TiledOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adabdd41470e9d9130c2e9505dcace719d9">KER_ARG_NTILES</a>))</div><div class="line">      )</div><div class="line">    ),</div><div class="line">    <span class="comment">// 2 User kernel arguments</span></div><div class="line">    <a class="code" href="group__UserKArg.html#gafdb4098fb8678d382b89763924cc3499">KerArgs</a>(2,</div><div class="line">      <span class="comment">// A double buffered input taken from level 2 memory</span></div><div class="line">      <span class="comment">// bound to C user kernel In</span></div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga1e3ffc7438780fc2a3a08eca121a3de5a40a3c67e7f0a9c49945c4272d4f06de3">OBJ_IN_DB</a>, W, H,</div><div class="line">        <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 0, 0, 0, <span class="stringliteral">&quot;In&quot;</span>, 0),</div><div class="line">      <span class="comment">// A dynamic buffer declared as W=1 and height=H but H will</span></div><div class="line">      <span class="comment">// be reduced to the number of used tiles</span></div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;TiledOut&quot;</span>, OBJ_BUFFER_DYN,</div><div class="line">        1, H, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 0, 0, 0, 0, 0)</div><div class="line">    )</div><div class="line">  );</div><div class="line">}</div></div><!-- fragment --><p>And here is the code that is generated by the auto-tiler after a call to MatrixMax("MatMax", 200, 300)</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> MatMax(</div><div class="line">                <span class="keywordtype">int</span> * __restrict__ In,</div><div class="line">                <span class="keywordtype">int</span> * __restrict__ Out,</div><div class="line">                <a class="code" href="structKernel__T.html">Kernel_T</a> *Ker)</div><div class="line"></div><div class="line">{</div><div class="line">  <span class="comment">/* Local variables used by this kernel */</span></div><div class="line">  <span class="keywordtype">int</span> DmaR_Evt1;</div><div class="line">  <span class="keywordtype">int</span> Iter, Last, NextLast, NextNextLast, InPlane, OutPlane=0;</div><div class="line">  <span class="keywordtype">int</span> N_Ti = 0, N_TiIp = 0;</div><div class="line">  MatrixMax_Arg_T S_KerArg0, *KerArg0 = &amp;S_KerArg0;</div><div class="line"></div><div class="line">  <span class="comment">/* Initialize KerArg, Kernel invariant arguments */</span></div><div class="line">  KerArg0-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#a4d088ab1417414e2a21fbcdf600ee109">W</a> = (<span class="keywordtype">unsigned</span> int) (200);</div><div class="line">  KerArg0-&gt;CompareWithOut = (<span class="keywordtype">unsigned</span> int) (0);</div><div class="line">  <span class="comment">/* ================Read First Tile================ */</span></div><div class="line">  <span class="comment">/* Initial reads in L2, O_DB or O_BUFF */</span></div><div class="line">  DmaR_Evt1 =  gap8_dma_memcpy((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) In+(0),</div><div class="line">      (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 0)+0, 24800, DMA_COPY_IN);</div><div class="line">  <span class="comment">/* ================End Read First Tile================ */</span></div><div class="line">  <span class="comment">/* Kernel Iteration Loop on tiled inner space */</span></div><div class="line">  <span class="keywordflow">for</span> (Iter=0; Iter&lt;10; Iter++) {</div><div class="line">    <span class="comment">/* Loop Iteration Body on tiled inner space */</span></div><div class="line">    <span class="comment">/* Elaborate Last, Next_Last, Next_Next_Last */</span></div><div class="line">    Last = ((Iter+1) == 10);</div><div class="line">    NextLast = ((Iter+2) == 10);</div><div class="line">    NextNextLast = ((Iter+3) == 10);</div><div class="line">    <span class="comment">/* ================Read Next Tile================ */</span></div><div class="line">    gap8_dma_wait(DmaR_Evt1);</div><div class="line">    <span class="keywordflow">if</span> (!Last) {</div><div class="line">      DmaR_Evt1 =  gap8_dma_memcpy(</div><div class="line">        (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) In + ((Iter+1)*24800),</div><div class="line">        (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 0) + 24800*((N_Ti+1) % 2),</div><div class="line">        NextLast?16800:24800, DMA_COPY_IN);</div><div class="line">    }</div><div class="line">    <span class="comment">/* ================End Read Next Tile================ */</span></div><div class="line">    <span class="comment">/* Call Kernel LOC_INNER_LOOP */</span></div><div class="line">    KerArg0-&gt;In = (Word32 * __restrict__)</div><div class="line">      ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 0) + 24800*(N_Ti % 2));</div><div class="line">    KerArg0-&gt;Out = (Word32 * __restrict__)</div><div class="line">      ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 49600) + 0 + (Iter)*4);</div><div class="line">    KerArg0-&gt;H = (<span class="keywordtype">unsigned</span> int) (Last?21:31);</div><div class="line">    KerArg0-&gt;TileIndex = (<span class="keywordtype">unsigned</span> int) Iter;</div><div class="line">    gap8_task_dispatch((1&lt;&lt;gap8_ncore())-1, KerMatrixMax,</div><div class="line">      (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) KerArg0);</div><div class="line">    KerMatrixMax(KerArg0);</div><div class="line">    N_Ti++;</div><div class="line">    <span class="comment">/* End Kernel Iteration Loop on tiled inner space */</span></div><div class="line">  }</div><div class="line">  Iter=10;</div><div class="line">  <span class="comment">/* Call Kernel LOC_INNER_LOOP_EPILOG */</span></div><div class="line">  KerMatrixMaxReduction(</div><div class="line">    (Word32 * __restrict__)</div><div class="line">      ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (L1_Memory + 49600) + 0),</div><div class="line">    (Out),</div><div class="line">    (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)10</div><div class="line">  );</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="section7"></a>
Basic kernels</h2>
<p>Basic kernels are written assuming all their data can fit into the shared level 1 memory. Usually a kernel function will access a data chunk through a pointer argument and will be informed about the data chunk characteristics by means of dimension arguments. A basic kernel manipulates a tile: one access pointer, one width argument and one height argument (a tile can also be of dimension 1). Scalar arguments, shared level 1 preloaded arguments, arguments accessed directly in level 2 can also be used by a basic kernel.</p>
<p>Basic kernels can be either sequential or parallel. A sequential kernel will run on a single core (core 0 of the cluster). For example, a sequential kernel can handle the configuration of the HWCE convolutional accelerator. A parallel kernel is meant to be run on all the available cores of the cluster. When it is called it is dispatched on all the active cores. Writing an optimized kernel usually involves dealing with vectorization to get as much as performance as possible from a single core and then dealing with parallelism to use as many cores in the cluster as possible.</p>
<p>Basic kernels define the functions manipulated by the GAP8 tile generator. Their interfaces (C data type template) as well as their calling nature (parallel versus sequential) are modeled.</p>
<p>The functions that the basic kernel models describe are called by the auto-tiler at runtime so should be in functions in source external to the model.</p>
<p>The following API is used to add a basic kernel model.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__BasicK.html#ga063761c92b60c97b3d9ab7cf86c75567">LibKernel</a>(</div><div class="line">  <span class="comment">// A string. The name of the kernel</span></div><div class="line">  <span class="keywordtype">char</span> *KernelName,</div><div class="line">  <span class="comment">// CALL_SEQUENTIAL when called only by cluster&#39;s core 0</span></div><div class="line">  <span class="comment">// CALL_PARALLEL when dispatched on all available cluster cores</span></div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gac8ad19c11fd96ccc1286845c0048d584">KernelCallTypeT</a> CallType,</div><div class="line">  <span class="comment">// List of C arguments &lt;Type, Name&gt; where Type and Name are strings.</span></div><div class="line">  <span class="comment">// Provided by CArgs(ArgCount, List of CArgs)</span></div><div class="line">  <a class="code" href="structCKernel__Arg__T.html">CKernel_Arg_T</a> **Cargs,</div><div class="line">  <span class="comment">// C typedef name, used when CallType is parallel since</span></div><div class="line">  <span class="comment">// in this case arguments have to be promoted to a C structure</span></div><div class="line">  <span class="keywordtype">char</span> *ParArgTypeName</div><div class="line">);</div></div><!-- fragment --><h3><a class="anchor" id="section8"></a>
Example 1 - Parallel basic kernel</h3>
<p>In this first example we show how to write a basic kernel performing a parallel addition between two 2D integer matrices with a fixed, bias offset.</p>
<p>The parallel addition will look like:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    Word32 * __restrict__ In1;</div><div class="line">    Word32 * __restrict__ In2;</div><div class="line">    Word32 * __restrict__ Out;</div><div class="line">    Word32 Bias;</div><div class="line">    Wordu32 W;</div><div class="line">    Wordu32 H;</div><div class="line">} <a class="code" href="structMatrixAdd__Arg__T.html">MatrixAdd_Arg_T</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MatrixAdd(<a class="code" href="structMatrixAdd__Arg__T.html">MatrixAdd_Arg_T</a> *Arg)</div><div class="line"></div><div class="line">{</div><div class="line">  Word32 * __restrict__ In1 = Arg-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#afa74ff0a06e1fd36593784e9a9e0ab74">In1</a>;   <span class="comment">// First input int matrix</span></div><div class="line">  Word32 * __restrict__ In2 = Arg-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#a1665d591230d89cc24c5a435c71165ed">In2</a>;   <span class="comment">// Second input int matrix</span></div><div class="line">  Word32 * __restrict__ Out = Arg-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#a6eb919d3c3bd426a9d5b38202c1213cd">Out</a>;   <span class="comment">// output int matrix</span></div><div class="line">  <span class="comment">// Pointer to a bias to be added to each matrix element sum</span></div><div class="line">  Word32 * __restrict__ Bias = Arg-&gt;Bias;   </div><div class="line">  Wordu32 W = Arg-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#a4d088ab1417414e2a21fbcdf600ee109">W</a>;       <span class="comment">// Width of the working space</span></div><div class="line">  Wordu32 H = Arg-&gt;<a class="code" href="structMatrixAdd__Arg__T.html#ab0d9729345982dcc92fcff8ec66cf0c9">H</a>;       <span class="comment">// Height of the working space</span></div><div class="line">  Wordu32 CoreId = gap8_coreid();     <span class="comment">// Who am I?</span></div><div class="line">    <span class="comment">// The size of the working space is W*H, divide it by number of cores</span></div><div class="line">    <span class="comment">// (a ChunkCell)</span></div><div class="line">  Wordu32 ChunkCell = ChunkSize(W*H);   </div><div class="line">    <span class="comment">// Given who we are this is the first chunk in the working space</span></div><div class="line">    <span class="comment">// we are interested in</span></div><div class="line">  Wordu32 First = CoreId*ChunkCell;</div><div class="line">      <span class="comment">// Given First chunk, last chunk is either full sized or capped</span></div><div class="line">      <span class="comment">// to working space size</span></div><div class="line">  Wordu32 Last  = <a class="code" href="group__AutoTilerTypes.html#ga9e04209162ea72f9985338596262b657">Min</a>(First+ChunkCell, W*H);  </div><div class="line">  <span class="keywordtype">int</span> i;</div><div class="line">  <span class="keywordflow">for</span> (i=First; i&lt;Last; i++)</div><div class="line">          Out[i] = In1[i] + In2[i] + Bias;</div><div class="line">  <span class="comment">// Wait on barrier until all the cores have got to here</span></div><div class="line">  rt_team_barrier();         </div><div class="line">}</div></div><!-- fragment --><p>And this is how the function is modeled as a basic kernel:</p>
<div class="fragment"><div class="line"><a class="code" href="group__BasicK.html#ga063761c92b60c97b3d9ab7cf86c75567">LibKernel</a>(<span class="stringliteral">&quot;MatrixAdd&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#ggac8ad19c11fd96ccc1286845c0048d584ab7f7e0d8ffdbbdbb19983c00561c0f83">CALL_PARALLEL</a>,</div><div class="line">  <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(6,</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In1&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In2&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32&quot;</span>, <span class="stringliteral">&quot;Bias&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Wordu32&quot;</span>, <span class="stringliteral">&quot;W&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Wordu32&quot;</span>, <span class="stringliteral">&quot;H&quot;</span>)</div><div class="line">  ),</div><div class="line">  <span class="stringliteral">&quot;MatrixAdd_Arg_T&quot;</span></div><div class="line">);</div></div><!-- fragment --><h3><a class="anchor" id="section9"></a>
Example 2 - Sequential basic kernel</h3>
<p>The second example shows how to model a sequential function to switch on the HWCE accelerator.</p>
<p>In this case, this is a simple sequential call to a preexisting library function. The C function to switch on the HWCE is in the GAP8 run-time and is called HWCE_Enable()</p>
<p>This is the way this call is modeled.</p>
<div class="fragment"><div class="line"><a class="code" href="group__BasicK.html#ga063761c92b60c97b3d9ab7cf86c75567">LibKernel</a>(<span class="stringliteral">&quot;HWCE_Enable&quot;</span>,  <a class="code" href="group__AutoTilerTypes.html#ggac8ad19c11fd96ccc1286845c0048d584a6a3dd38f3ae3e431987a5a50003c866b">CALL_SEQUENTIAL</a>, <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(0), <span class="stringliteral">&quot;&quot;</span>);</div></div><!-- fragment --><h2><a class="anchor" id="section10"></a>
User kernels</h2>
<h3><a class="anchor" id="section11"></a>
Iteration dimension, iteration space, iteration order, tiling direction</h3>
<p>The iteration space of a user kernel can be of dimension 1, 2, 3, or 4.</p>
<p>The inner level of the iteration space is assumed to be 2D (with 1D as a special case where one of the inner dimensions is set to 1). The inner level is the one that will be tiled by GAP8 auto-tiler. In this document we refer to this inner level as a plane, either input or output.</p>
<ul>
<li>A 2D input has width W and height H.</li>
<li>A 3D input is a collection of Nip 2D structure, so it's dimension is [Nip x W x H], where Nip stands for number of input planes.</li>
<li>Similarly, a 3D output is a collection of Nop 2D structures, with dimension [W x H x Nop], where Nop stands for number of output planes.</li>
<li>A 4D input is a collection of Nip x Nop 2D structures, with dimension [Nip x W x H x Nop]</li>
</ul>
<p><em><b>Note: A 2D input or output can be embedded into an iteration space whose dimension is greater than 2. In this case each 2D plane is consumed several times.</b></em></p>
<p>Two different iteration orders are supported when dimension is greater or equal than 3:</p>
<h4><a class="anchor" id="section12"></a>
Order 1</h4>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (Op=0; Op&lt;Nop; Op++) {</div><div class="line">  <span class="keywordflow">for</span> (Ip=0; Ip&lt;Nip; Ip++) {</div><div class="line">    <span class="keywordflow">for</span> (Tile=0; Tile&lt;LastTile; Tile++) {</div><div class="line">      Foo(DataTile[Ip, Tile, Op]);</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p>The diagrams Below illustrate how tiles are traversed as a function of the dimension of the iteration space in Order 1.</p>
<div class="image">
<img src="images/order1.png" alt="Tile traversal order 1"/>
</div>
<h4><a class="anchor" id="section13"></a>
Order 2</h4>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (Op=0; Op&lt;Nop; Op++) {</div><div class="line">  <span class="keywordflow">for</span> (Tile=0; Tile&lt;LastTile; Tile++) {</div><div class="line">    <span class="keywordflow">for</span> (Ip=0; Ip&lt;Nip; Ip++) {</div><div class="line">      Foo(DataTile[Ip, Tile, Op]);</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p>The diagrams Below illustrate how tiles are traversed as a function of the dimension of the iteration space in Order 2.</p>
<div class="image">
<img src="images/order2.png" alt="Tile traversal order 2"/>
</div>
<p>In the current implementation only order 2 is fully supported.</p>
<p>Tiles have 2 possible orientations:</p>
<p><em><b>Horizontal:</b></em> The [W x H] data plane is divided into N tiles of size [W x h] and one last tile of size [W x hlast] where hlast &lt; h</p>
<div class="image">
<img src="images/horizontal_traversal.png" alt="Horizontal traversal"/>
</div>
<p><em><b>Vertical:</b></em> The [W x H] data plane is divided into N tiles of size [w x H] and one last tile of size [wlast x H] where wlast &lt; w</p>
<div class="image">
<img src="images/vertical_traversal.png" alt="Vertical traversal"/>
</div>
<p>It is important to note that one of the 2 dimensions is left untouched so a single line or a single column must fit into the memory constraints given to GAP8 auto-tiler.</p>
<p>Deciding which orientation to choose is driven by the nature of the algorithm. For example, a function computing a bi-dimensional FFT on a 2D input plane of size [S x S] will execute in two passes. A first pass where a 1D FFT is applied on each line so the natural choice is horizontal. Then the second pass will apply a 1D FFT on each column of the 2D plane produced by the first pass, so vertical is the natural choice.</p>
<p>In the current implementation the orientation choice applies to all user kernel arguments. In future version this constraint will be removed to allow the developer to decide a different orientation for each kernel argument.</p>
<h3><a class="anchor" id="section14"></a>
User kernel fields</h3>
<p>A user kernel is a collection of fields. The following library function is used to create a user kernel:</p>
<div class="fragment"><div class="line"><a class="code" href="structKernel__T.html">Kernel_T</a> *<a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(</div><div class="line">  <span class="keywordtype">char</span> *TemplateName,</div><div class="line">  KernelDimensionT *<a class="code" href="group__ArgBind.html#gab3e01f5e85281ff299fbeea702dabcca">KerDim</a>,</div><div class="line">  KernelIterationT *KerIter,</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#ga57ccb2b0bd6aae9142731ac85849e258">Tile_Orientation_T</a> Orientation,</div><div class="line">  <a class="code" href="structCKernel__Arg__T.html">CKernel_Arg_T</a> **CArg,</div><div class="line">  <a class="code" href="structCKernelCall__T.html">CKernelCall_T</a> **CCalls,</div><div class="line">  <a class="code" href="structObject__T.html">Object_T</a> **<a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>);</div></div><!-- fragment --><p>The following sections describe the content of each of the user kernel fields.</p>
<h4><a class="anchor" id="section15"></a>
TemplateName - kernel name</h4>
<p>A string with the kernel name which must be unique.</p>
<div class="fragment"><div class="line"><a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<span class="stringliteral">&quot;MyFavoriteKernel&quot;</span>,</div><div class="line">   ...</div><div class="line">);</div></div><!-- fragment --><h4><a class="anchor" id="section16"></a>
KerDim - kernel dimensions</h4>
<p>Specifies the number of input planes (<code>Nip</code>), number of output planes (<code>Nop</code>), default width (<code>W</code>) and height (<code>H</code>) of a plane for the user kernel.</p>
<p>Note that <code>Nip</code> and <code>Nop</code> are shared by all kernel arguments while <code>W</code> and <code>H</code> can be redefined for each kernel argument.</p>
<p>The following library function is provided to capture the user kernel dimension info:</p>
<div class="fragment"><div class="line">KernelDimensionT *KernelDimensions(</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> InPlanes,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> W,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> H,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> OutPlanes);</div></div><!-- fragment --><p>For example, <code>MyFavoriteKernel</code> below has 4 input planes, 4 output planes and a default data plane of 32 column and 28 lines:</p>
<div class="fragment"><div class="line"><a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<span class="stringliteral">&quot;MyFavoriteKernel&quot;</span>,</div><div class="line">  KernelDimensions(4, 32, 28, 4),</div><div class="line">  ...</div><div class="line">);</div></div><!-- fragment --><h4><a class="anchor" id="section17"></a>
KerIter - kernel iteration order</h4>
<p>The iteration order captures the overall structure of the user kernel. First the number of dimensions and then the way the iteration is traversed.</p>
<p>Dimensions: <code>KER_DIM2</code>, <code>KER_DIM3</code>, <code>KER_DIM4</code></p>
<p><em><b>Iteration Order 1</b></em></p>
<p><code>KER_DIM2</code>, <code>KER_TILE</code></p>
<p>: 2D. Tiled inner data plane</p>
<p><code>KER_DIM3</code>, <code>KER_IN_PLANE</code>, <code>KER_TILE</code></p>
<p>: 3D. For each <code>Nip</code> in data planes all tiles in a plane, <code>Nop</code> is treated as equal to 1</p>
<p><code>KER_DIM3</code>, <code>KER_OUT_PLANE</code>, <code>KER_TILE</code></p>
<p>: 3D. For each <code>Nop</code> out data planes all tiles in a single input plane, <code>Nip</code> is treated as equal to 1</p>
<p><code>KER_DIM4</code>, <code>KER_OUT_PLANE</code>, <code>KER_IN_PLANE</code>, <code>KER_TILE</code></p>
<p>: 4D. For each <code>Nop</code> out data planes, for each <code>Nip</code> input data planes, for all tile in plane</p>
<p><em><b>Iteration Order 2</b></em></p>
<p>KER_DIM2, KER_TILE</p>
<p>: 2D. Tiled inner data plane</p>
<p>KER_DIM3, KER_TILE, KER_IN_PLANE</p>
<p>: 3D. For each tile of each Nip input planes, Nop is treated as equal to 1</p>
<p>KER_DIM3, KER_OUT_PLANE, KER_TILE</p>
<p>: 3D. For each Nop out data planes all tiles in a single input plane, Nip is treated as equal to 1</p>
<p>KER_DIM4, KER_OUT_PLANE, KER_TILE, KER_IN_PLANE</p>
<p>: 4D. For each Nop out data planes, for each tile in each Nip input data planes</p>
<p>This is the general iteration pattern for a user kernel, then each kernel argument can traverse the whole iteration space or only a subset. For example, a 2D kernel argument when embedded in a 4D user kernel will iterate Nip*Nop times on the same WxH data plane.</p>
<p>Note: currently only Iteration Order 2 is fully supported.</p>
<p>For example, MyFavoriteKernel below follows iteration Order 2: 4 dimensions, first out-planes then tiles then in-planes:</p>
<div class="fragment"><div class="line"><a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<span class="stringliteral">&quot;MyFavoriteKernel&quot;</span>,</div><div class="line">  KernelDimensions(4, 32, 28, 4),</div><div class="line">  KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4caed92cdcd78693866bbd9f0ab0198afc4">KER_DIM4</a>, KER_OUT_PLANE, KER_TILE, KER_IN_PLANE),</div><div class="line">  ...</div><div class="line">);</div></div><!-- fragment --><h4><a class="anchor" id="section18"></a>
Orientation - Tiling orientation</h4>
<p>In a 2D data plane of dimension W x H, tiling can be performed horizontally or vertically. Currently this is a user kernel level parameter and all user kernel arguments are tiled in the same direction. In the future global orientation will be able to be overridden on a per argument basis.</p>
<p>When a 2D data plane is tiled, all the tiles except the last one will have the same size. This size is computed to gain maximum benefit from the configured memory budget.</p>
<p>Orientation can be: TILE_HOR or TILE_VER</p>
<p>For example MyFavoriteKernel below will tile the data plane horizontally.</p>
<div class="fragment"><div class="line"><a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<span class="stringliteral">&quot;MyFavoriteKernel&quot;</span>,</div><div class="line">  KernelDimensions(4, 32, 28, 4),</div><div class="line">  KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4caed92cdcd78693866bbd9f0ab0198afc4">KER_DIM4</a>, KER_OUT_PLANE, KER_TILE, KER_IN_PLANE),</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258a42bffded6e7107d8c7f2570b28748ba5">TILE_HOR</a>,</div><div class="line">  ...</div><div class="line">);</div></div><!-- fragment --><h4><a class="anchor" id="section19"></a>
CArg - User kernel function template</h4>
<p>A user kernel will end up as a C function after it has been processed by the auto tiler. For this reason, the C template of this function must be provided. This is like the template provided for a basic kernel, i.e. a list of C variable names and their associated C types.</p>
<p>The CArgs library function is used to do this. It takes two parameters. Firstly, the number of C arguments and secondly a list of parameters modeled as <code>&lt;Type Name, Arg Name&gt;</code> pairs, the <code>TCArg</code> function is used to create the pair.</p>
<div class="fragment"><div class="line"><a class="code" href="structCKernel__Arg__T.html">CKernel_Arg_T</a> **<a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ArgCount,</div><div class="line">  ...</div><div class="line">);</div><div class="line"></div><div class="line"><a class="code" href="structCKernel__Arg__T.html">CKernel_Arg_T</a> *<a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(</div><div class="line">  <span class="keywordtype">char</span> *ArgType,</div><div class="line">  <span class="keywordtype">char</span> *ArgName);</div></div><!-- fragment --><p>For example MyFavoriteKernel below has 4 C arguments: In1, In2, Out and Bias with their respective C types.</p>
<div class="fragment"><div class="line"><a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<span class="stringliteral">&quot;MyFavoriteKernel&quot;</span>,</div><div class="line">  KernelDimensions(4, 32, 28, 4),</div><div class="line">  KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4caed92cdcd78693866bbd9f0ab0198afc4">KER_DIM4</a>, KER_OUT_PLANE, KER_TILE, KER_IN_PLANE),</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258a42bffded6e7107d8c7f2570b28748ba5">TILE_HOR</a>,</div><div class="line">  <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(4,</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In1&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In2&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>)</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Bias&quot;</span>)</div><div class="line">  ),</div><div class="line">  ...</div><div class="line">);</div></div><!-- fragment --><p>You will note here that the dimension of the arguments is not passed, they will be captured in the kernel argument description part of the model if they are candidates for tiling. In case that they are pure C arguments, not candidates for tiling, then their dimensions should be passed.</p>
<h4><a class="anchor" id="section20"></a>
CCalls - Basic kernels call sequence, call position and arguments</h4>
<p>The CCalls field indicates the link between the User Kernel and one or more Basic Kernels. It models the sequence, call position and argument bindings for Basic Kernels called from this user kernel.</p>
<h5>Call sequence</h5>
<p>The location of calls to basic kernels in the user kernel iteration sequence depends on the iteration order, Order 1 or Order 2.</p>
<p>Here are the locations where calls can be inserted as a function of iteration order:</p>
<div class="fragment"><div class="line">LOC_INNER_LOOP</div><div class="line">LOC_INNER_LOOP_PROLOG</div><div class="line">LOC_INNER_LOOP_EPILOG</div><div class="line">LOC_IN_PLANE_PROLOG</div><div class="line">LOC_IN_PLANE_EPILOG</div><div class="line">LOC_PROLOG</div><div class="line">LOC_EPILOG</div></div><!-- fragment --><p>The code fragments below show where the calls are inserted in relation to the two possible iteration orders:</p>
<p><em><b>Iteration Order 1</b></em></p>
<div class="fragment"><div class="line">&lt;LOC_PROLOG&gt;</div><div class="line">  for (Op=0; Op&lt;Nop; Op++) {</div><div class="line">    &lt;LOC_IN_PLANE_PROLOG&gt;</div><div class="line">    for (Ip=0; Ip&lt;Nip; Ip++) {</div><div class="line">      &lt;LOC_INNER_LOOP_PROLOG&gt;</div><div class="line">      for (Tile=0; Tile&lt;LastTile; Tile++) {</div><div class="line">        &lt;LOC_INNER_LOOP&gt;</div><div class="line">        Foo(DataTile[Ip, Tile, Op]);</div><div class="line">      }</div><div class="line">      &lt;LOC_INNER_LOOP_EPILOG&gt;</div><div class="line">    }</div><div class="line">    &lt;LOC_IN_PLANE_EPILOG&gt;</div><div class="line">  }</div><div class="line">&lt;LOC_EPILOG&gt;</div></div><!-- fragment --><p><em><b>Iteration Order 2</b></em></p>
<div class="fragment"><div class="line">&lt;LOC_PROLOG&gt;</div><div class="line">  for (Op=0; Op&lt;Nop; Op++) {</div><div class="line">    &lt;LOC_INNER_LOOP_PROLOG&gt;</div><div class="line">    for (Tile=0; Tile&lt;LastTile; Tile++) {</div><div class="line">      &lt;LOC_INNER_PLANE_EPILOG&gt;</div><div class="line">      for (Ip=0; Ip&lt;Nip; Ip++) {</div><div class="line">        &lt;LOC_INNER_LOOP&gt;</div><div class="line">        Foo(DataTile[Ip, Tile, Op]);</div><div class="line">      }</div><div class="line">      &lt;LOC_INNER_PLANE_EPILOG&gt;</div><div class="line">    }</div><div class="line">    &lt;LOC_INNER_LOOP_EPILOG&gt;</div><div class="line">  }</div><div class="line">&lt;LOC_EPILOG&gt;</div></div><!-- fragment --><h5>Call order</h5>
<p>At each insertion point, calls are inserted in the order they appear in the user kernel call sequence.</p>
<p>User kernel calls are captured by the following library call, the number of calls in the user kernel and then a list of basic kernels calls:</p>
<div class="fragment"><div class="line"><a class="code" href="structCKernelCall__T.html">CKernelCall_T</a> **<a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> CallCount,</div><div class="line">  ...</div><div class="line">);</div></div><!-- fragment --><p>Each call is captured by:</p>
<div class="fragment"><div class="line"><a class="code" href="structCKernelCall__T.html">CKernelCall_T</a> *<a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(</div><div class="line">  <span class="keywordtype">char</span> *CallName,</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gacfeda3b2985b27a751ebce59c4d821c7">KernelCallLocationT</a> CallLocation,</div><div class="line">  <a class="code" href="structArgBindingDescr__T.html">ArgBindingDescr_T</a> **BindingList</div><div class="line">);</div></div><!-- fragment --><p>Where CallName is a basic kernel name that must exist, CallLocation is a call location in the iteration template and BindingList is a list of bindings between basic kernel C formal arguments and different entities:</p>
<div class="fragment"><div class="line"><a class="code" href="structArgBindingDescr__T.html">ArgBindingDescr_T</a> **<a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(</div><div class="line">  <span class="keywordtype">int</span> BCount,</div><div class="line">  ...</div><div class="line">);</div></div><!-- fragment --><h5>Call bindings</h5>
<p>Each argument for each call can be bound to combination of user kernel arguments (tiles or attribute of tiles such as tile width and tile height), plain C arguments or immediate values.</p>
<p>The possible binding sources are listed below.</p>
<h6>User kernel arguments - tile</h6>
<p><code>K_Arg(UserKernelArgName, KER_ARG_TILE)</code></p>
<p>: Pointer to a tile</p>
<h6>User kernel arguments - entire data plane</h6>
<p><code>K_Arg(UserKernelArgName, KER_ARG)</code></p>
<p>: Pointer to data plane</p>
<h6>User kernel argument attributes</h6>
<p>Apply to tiled kernel arguments.</p>
<p><code>K_Arg(UserKernelArgName, KER_ARG_TILE_W)</code></p>
<p>: Width of the current tile. Unsigned int.</p>
<p><code>K_Arg(UserKernelArgName, KER_ARG_TILE_W0)</code></p>
<p>: Default tile width, last tile can be smaller. Unsigned int.</p>
<p><code>K_Arg(UserKernelArgName, KER_ARG_TILE_H)</code></p>
<p>: Height of the current tile. Unsigned int</p>
<p><code>K_Arg(UserKernelArgName, KER_ARG_TILE_H0)</code></p>
<p>: Default tile height, last tile can be smaller</p>
<p><code>K_Arg(UserKernelArgName, KER_ARG_NTILES)</code></p>
<p>: Number of tiles in the data plane. Unsigned int.</p>
<p><code>K_Arg(UserKernelArgName, KER_ARG_TILEINDEX)</code></p>
<p>: Current tile index. Unsigned int.</p>
<p><code>K_Arg(UserKernelArgName, KER_ARG_TILEOFFSET)</code></p>
<p>: Current tile offset starting from the origin of the iteration sub space of this user kernel argument. Unsigned int.</p>
<h6>User kernel C arguments</h6>
<p><code>C_Arg(UserKernelCArgName)</code></p>
<h6>Subscripted user kernel C arguments</h6>
<p>Subscripted by the current index of input plane, output plane or tile multiplied by a constant</p>
<p><code>C_ArgIndex(UserKernelCArgName, [Iterator], MultFactor)</code></p>
<p>: where [Iterator] is KER_IN_PLANE, KER_OUT_PLANE or KER_TILE. Note that the C kernel argument has to be a pointer for this binding to be legal</p>
<h6>Immediate values</h6>
<p><code>Imm(ImmediateIntegerValue)</code></p>
<p><b>Note:</b> the binding list order has to follow the basic kernel argument list order.</p>
<p>For example MyFavoriteKernel below contains a single call to the library kernel MatrixAdd located in the inner loop</p>
<div class="fragment"><div class="line"><a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<span class="stringliteral">&quot;MyFavoriteKernel&quot;</span>,</div><div class="line">  KernelDimensions(4, 32, 28, 4),</div><div class="line">  KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4caed92cdcd78693866bbd9f0ab0198afc4">KER_DIM4</a>, KER_OUT_PLANE, KER_TILE, KER_IN_PLANE),</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258a42bffded6e7107d8c7f2570b28748ba5">TILE_HOR</a>,</div><div class="line">  <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(4,</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In1&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In2&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">    <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Bias&quot;</span>)</div><div class="line">  ),</div><div class="line">  <a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(1,</div><div class="line">    <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;MatrixAdd&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">      <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(6,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn1&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),    <span class="comment">// A tile</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn2&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),    <span class="comment">// A tile</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),    <span class="comment">// A tile</span></div><div class="line">        <a class="code" href="group__ArgBind.html#gaf3226f1f3741f134ff6843de3bdf1d4e">C_ArgIndex</a>(<span class="stringliteral">&quot;Bias&quot;</span>, KER_OUT_PLANE, 1), <span class="comment">// Bias[CurrentOutputPlane*1]</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn1&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>),    <span class="comment">// Tile width</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn1&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>)   <span class="comment">// Tile height</span></div><div class="line">      )</div><div class="line">    )</div><div class="line">  ),</div><div class="line">  ...</div><div class="line">);</div></div><!-- fragment --><h4><a class="anchor" id="section21"></a>
KerArg - User kernel arguments</h4>
<p>User kernel arguments are the inputs and outputs to the user kernel, the entities that will undergo tiling to allow them to fit into the available level 1 memory.</p>
<ol type="1">
<li>A user kernel argument has a direction: input, output or input output. It can be buffered or not. Being buffered means that the entire argument content is moved into level 1 memory before the user kernel iteration space is traversed and is returned to level 2 or level 3 memory afterwards.</li>
<li>A user kernel argument is a collection of data planes of width W and height H. In the simplest case the data plane is a collection of 1, it is a 2D structure (Note that if you need to process 1D data you set H to 1). In more elaborate cases the kernel argument can be of dimension 3 or of dimension 4. If the direction of the argument is IN then a 3D argument is a collection of Nip WxH input data planes. Similarly, if the direction of the argument is OUT and only OUT (IN_OUT is considered as IN) then the kernel argument will be a collection of Nop W x H output data planes. A 4D argument in the current implementation can only be an input and is a collection of Nip x Nop, W x H input data planes. A user kernel argument is fully characterized by its declared width and height, its dimension and the number of input and output data planes shared by all user kernel arguments and declared in the user kernel dimension section. Note that the width and height override the default values of the kernel dimension section.</li>
<li>A user kernel argument has a home location in level 2 memory, the default, or in external, level 3 memory. In the case that an argument is in the external memory it can be of OUT type only if the external memory can support it. External flash only supports IN arguments while external RAM supports both IN and OUT arguments. As a special case, uninitialized buffers are transient objects with a home location in the shared level 1 memory.</li>
<li>A user kernel argument can be accessed in a non-pipelined way or in a pipelined way (double or triple buffered). When non-pipelined, memory transfers will affect performance since the kernel must wait for the end of the memory transfer before moving on. When pipelined, the memory transfer is performed in a different buffer than the one used for the current tile. Therefore it has all the cycles between the read and the first usage in the next iteration to complete. If the compute time spent in the basic kernels is higher than the number of cycles spent for the memory transfer, the memory transfer will not affect performance. External memory kernel arguments are always treated as pipelined object. The bandwidth gap between the external memory and the shared level 1 or the level 2 memory is such that it makes little sense to perform non-pipelined accesses to or from level 3 memory. For arguments in level 2 memory, the user can decide to let the kernel access them in a pipelined way or not.</li>
<li>Kernel arguments can be bound to user kernel arguments but can also be bound to an output argument of another user kernel argument belonging to the same group of user kernels (see after). They can even be working transient memory (buffer) that the kernel needs for its own sake. This buffer can be a full size data plane or only a single tile whose exact dimension will be figured out by the auto tiler.</li>
</ol>
<p>As you can see, each user kernel argument can have a different width and height. The GAP8 automatic tiler models the ratios between these different dimensions and tries to find out a tile size (potentially different for each user kernel argument) that will fit within the shared level 1 memory budget it has been given. Tiles can be subject to additional constraints:</p>
<ul>
<li>They may have to overlap. This is the case when a 2D filter is applied on a 2D data plane. Let's assume that the set of filter coefficients is a 5 by 5 matrix then 2 adjacent tiles must overlap by 4 to be able to produce the correct output.</li>
<li>For algorithmic reasons it might be necessary to constrain a tile to be of odd or even size. For example, if the algorithm performs sub-sampling by a factor of 2 then all tiles but the last one must be of even dimension. Similarly, it can be desirable, for hardware constraint or performance reasons, to constrain a tile to be a multiple of a given constant. For example, on GAP8 the hardware convolution engine works best when it is consuming vertical strips of width 32 therefore if we set the tiling orientation to vertical and set the preferred tile size to be a multiple of 32, we will get maximum performance. As another example, if each line of a tile is given to a core for processing, then having a tile dimension being a multiple of 8 will ensure the 8 cores of the cluster are optimally balanced.</li>
</ul>
<p>All these constraints can be expressed in a user kernel argument.</p>
<p>To create a kernel argument, the following library call is used:</p>
<div class="fragment"><div class="line"><a class="code" href="structObject__T.html">Object_T</a> *<a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(</div><div class="line">  <span class="keywordtype">char</span> *KerArgName,</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#ga1e3ffc7438780fc2a3a08eca121a3de5">Object_Type_T</a> ObjType,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> W,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> H,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ItemSize,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> TileOverlap,</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#ga9f3051ed6b39a98bfebbe83abd8c912f">KernelArgConstraints_T</a> Constraint,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> PreferedTileSize,</div><div class="line">  <span class="keywordtype">char</span> *CArgName,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> NextPlaneUpdate);</div></div><!-- fragment --><h5>User kernel argument object type</h5>
<p>A user kernel argument object type is either a flag built from a set of basic user kernel argument properties or a pre-defined name.</p>
<p><em><b>Names built as a flag from user kernel argument properties</b></em></p>
<p>The set of pre-defined properties which can be OR'ed (|) together is:</p>
<p><code>O_IN, O_NIN</code> : Is an input or not an input</p>
<p><code>O_OUT, O_NOUT</code> : Is an output or not an output</p>
<p><code>O_BUFF, O_NBUFF</code> : Is a buffer or not a buffer</p>
<p><code>O_TILED, O_NTILED</code> : Is tiled or not. When not tiled, the whole data plane is accessible in shared level 1 memory. For example, a 2D convolution has one argument that is tiled (the input data) and another one that is not tiled (the coefficients)</p>
<p><code>O_ONETILE, O_NONETILE</code> : A buffer property. When ONETILE is set, a buffer of dimension WxH will be given only the dimension of a tile whose size is proportional to the size of the tiles generated for the other kernel arguments.</p>
<p><code>O_DYNTILE, O_NDYNTILE</code> : A buffer property. When O_DYNTILE, the height if tiling orientation is horizontal or the width if orientation is vertical, of the buffer will be adjusted to the number of tile computed by GAP8 auto-tiler. This is useful when a dynamic buffer is needed to implement a reduction phase after a result has been computed for each tile independently and final result must be obtained combining all these results into a single one. Usually the declared W or H is the one of another user kernel input and the auto-tiler adjusts it.</p>
<p><code>O_DB, O_NDB</code> : Argument is double or triple buffered in L1 memory, or it is not multi-buffered</p>
<p><code>O_L2DB, O_NL2DB</code> : Argument home location is an external memory and is double or triple buffered in level 2 memory, or it is not an external memory</p>
<p><code>O_3D, O_N3D</code> : Argument has 3 dimensions or not</p>
<p><code>O_4D, O_N4D</code> : Argument has 4 dimensions or not (note that a 4D argument is also a 3D one)</p>
<p>For example, <code>O_IN|O_DB|O_L2DB|O_4D</code> is an input pipelined in level 1 memory and in level 2 memory whose home location is external memory. Its dimension is 4.</p>
<p><em><b>Pre-defined names</b></em></p>
<p>The diagrams below summarize the set of pre-defined names.</p>
<div class="image">
<img src="images/predefined.png" alt="Pre-defined names"/>
</div>
<p>For example OBJ_IN_DB_L2DB_4D is an input pipelined in level 1 and in level 2 memory whose home location is external memory. It's dimension is 4.</p>
<h5>User kernel argument width and height</h5>
<p>A pair of unsigned ints specifying the dimension of the data plane.</p>
<h5>User kernel argument item size</h5>
<p>An unsigned int specifying the size in bytes of the data plane elementary data type.</p>
<h5>User kernel argument tile overlap</h5>
<p>An unsigned int capturing the amount of overlap between two adjacent tiles. This is useful in case an output is computed as a function of a point in the input data plane and its neighborhood. If to compute an output you need inputs at a maximum distance K from the point of computation then 2 adjacent tiles should overlap by at least 2*K points.</p>
<div class="image">
<img src="images/tile_overlap.png" alt="Tile overlap example"/>
</div>
<h5>User kernel argument constraints</h5>
<p>Specifies a constraint on a property of the tile dimension that is calculated by the GAP8 auto-tiler. When tiling is horizontal the constraint is on the height of the tile, and when tiling is vertical the constraint is on the width of the tile. A constraint will be applied by the auto-tiler to all the tiles except the last one. If this is not possible the model cannot be tiled.</p>
<p>These are the possible constraints:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga9f3051ed6b39a98bfebbe83abd8c912fa2a24a07f19230bf0d0ced66f16a438d0">OBJ_CONSTRAINTS_NONE</a> = 0,</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga9f3051ed6b39a98bfebbe83abd8c912fa32b7508ab2be5539a61571c574284bf7">OBJ_CONSTRAINTS_EVEN</a> = (1&lt;&lt;1),    <span class="comment">/* Tile variable size is even */</span></div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga9f3051ed6b39a98bfebbe83abd8c912fa0cb8b22726f6a2dec58ce717907f8411">OBJ_CONSTRAINTS_ODD</a> = (1&lt;&lt;2),     <span class="comment">/* Tile varaible size is odd */</span></div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga9f3051ed6b39a98bfebbe83abd8c912fa4697e64ce4d7fb135d9efff8f1f4077d">OBJ_CONSTRAINTS_ONEPREFTILE</a> = (1&lt;&lt;3),   <span class="comment">/* Limit number of used tile to just one */</span></div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga9f3051ed6b39a98bfebbe83abd8c912faaec3ebb5f1fbe13670626a1556f1c0d0">OBJ_CONSTRAINTS_TILE_HOR</a> = (1&lt;&lt;4),    <span class="comment">/* Overide default orientation to TILE_HOR */</span></div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga9f3051ed6b39a98bfebbe83abd8c912fa07b9104f8992f4781fb3d375bdadb779">OBJ_CONSTRAINTS_TILE_VER</a> = (1&lt;&lt;5),    <span class="comment">/* Overide default orientation to TILE_VER */</span></div><div class="line">} <a class="code" href="group__AutoTilerTypes.html#ga9f3051ed6b39a98bfebbe83abd8c912f">KernelArgConstraints_T</a>;</div></div><!-- fragment --><h5>User kernel argument preferred tile size</h5>
<p>Specifies the developer's preference for the dimension of the tile that is calculated by the GAP8 auto-tiler. It is expressed as an unsigned int and when not zero the preferred dimension of the tile chosen is a multiple of this value.</p>
<h5>User kernel argument binding to C user kernel argument</h5>
<p>Generally, a user kernel argument is connected to a C argument and in this case the name of this C argument should be provided. In the case where the user kernel argument is only internal to the user kernel or user kernel group then there is no binding and null (0) should be used.</p>
<h5>User kernel argument next plane update</h5>
<p>Generally, the mechanism to move from one data plane to another one in the iteration space for user kernel arguments with dimensions strictly greater than 2 is inferred from the object type. In some cases, it can be desirable to give a better control on this update process. For example, the GAP8 hardware convolution engine can produce 3 full 3 x 3 convolution outputs. Here 3 adjacent output data planes are involved and therefore the move to next group of outputs should use a step of 3 * size and not 1 * size of the output plane as is the case for an implicit update.</p>
<p>Next plane update is expressed as a non 0 unsigned integer. If 0 then default rule is applied.</p>
<p>Back to our simple matrix addition example, a possible final version is shown below:</p>
<div class="fragment"><div class="line"><a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<span class="stringliteral">&quot;MyFavoriteKernel&quot;</span>,</div><div class="line">  KernelDimensions(4, 32, 28, 4),</div><div class="line">  KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4caed92cdcd78693866bbd9f0ab0198afc4">KER_DIM4</a>, KER_OUT_PLANE, KER_TILE, KER_IN_PLANE),</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258a42bffded6e7107d8c7f2570b28748ba5">TILE_HOR</a>,</div><div class="line">  <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(4,</div><div class="line">  <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In1&quot;</span>),</div><div class="line">  <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In2&quot;</span>),</div><div class="line">  <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">  <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Bias&quot;</span>)</div><div class="line">  ),</div><div class="line">  <a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(1,</div><div class="line">    <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;MatrixAdd&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">      <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(6,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn1&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),    <span class="comment">// A tile</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn2&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),    <span class="comment">// A tile</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),    <span class="comment">// A tile</span></div><div class="line">        <a class="code" href="group__ArgBind.html#gaf3226f1f3741f134ff6843de3bdf1d4e">C_ArgIndex</a>(<span class="stringliteral">&quot;Bias&quot;</span>, KER_OUT_PLANE, 1), <span class="comment">// Bias[CurrentOutputPlane*1]</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn1&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>),    <span class="comment">// Tile width</span></div><div class="line">        <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;KerIn1&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>)   <span class="comment">// Tile height</span></div><div class="line">      )</div><div class="line">    )</div><div class="line">  ),</div><div class="line">  <a class="code" href="group__UserKArg.html#gafdb4098fb8678d382b89763924cc3499">KerArgs</a>(3,</div><div class="line">    <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;KerIn1&quot;</span>, OBJ_IN_DB_3D,     75, 75,  <span class="keyword">sizeof</span>(Word32), 0, 0, 0, <span class="stringliteral">&quot;In1&quot;</span>, 0),</div><div class="line">    <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;KerIn2&quot;</span>, OBJ_IN_DB_3D,     75, 75,  <span class="keyword">sizeof</span>(Word32), 0, 0, 0, <span class="stringliteral">&quot;In2&quot;</span>, 0),</div><div class="line">    <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;KerOut&quot;</span>, OBJ_OUT_DB_3D,    75, 75,  <span class="keyword">sizeof</span>(Word32), 0, 0, 0, <span class="stringliteral">&quot;Out&quot;</span>, 0)</div><div class="line">  )</div><div class="line">);</div></div><!-- fragment --><p>The first argument is an input coming from L2 memory and it is multi buffered in shared L1 memory so that performance is optimized. The basic plane is 75 x 75 of integers (4 bytes). It has 3 dimensions and since we have declared that we have 4 input planes in the KernelDimensions section we have 4 basic planes.</p>
<p>The second argument has the same characteristics than the first argument.</p>
<p>The third argument is an output that should go to level 2 memory and that is multi buffered in level 1 memory again to incur no performance penalty due to memory transfers. It has 3 dimensions and since we have declared that we have 4 output planes in the KernelDimensions section we have 4 basic planes.</p>
<p>The 3 user kernel arguments are tiled.</p>
<p>What this example does is to add in each output matrix the sum of all input matrices plus a scalar bias.</p>
<div class="fragment"><div class="line">Out[0] = (In1[0][75:75]+In2[0][75:75]+Bias[0]) +</div><div class="line">  (In1[1][75:75]+In2[1][75:75] + Bias[0]) +</div><div class="line">  (In1[2][75:75]+In2[2][75:75]+Bias[0]) +</div><div class="line">  (In1[3][75:75]+In2[3][75:75] + Bias[0]);</div><div class="line">Out[1] = (In1[0][75:75]+In2[0][75:75]+Bias[1]) +</div><div class="line">  (In1[1][75:75]+In2[1][75:75] + Bias[1]) +</div><div class="line">  (In1[2][75:75]+In2[2][75:75]+Bias[1]) +</div><div class="line">  (In1[3][75:75]+In2[3][75:75] + Bias[1]);</div><div class="line">Out[2] = (In1[0][75:75]+In2[0][75:75]+Bias[2]) +</div><div class="line">  (In1[1][75:75]+In2[1][75:75] + Bias[2]) +</div><div class="line">  (In1[2][75:75]+In2[2][75:75]+Bias[2]) +</div><div class="line">  (In1[3][75:75]+In2[3][75:75] + Bias[2]);</div><div class="line">Out[3] = (In1[0][75:75]+In2[0][75:75]+Bias[3]) +</div><div class="line">  (In1[1][75:75]+In2[1][75:75] + Bias[3]) +</div><div class="line">  (In1[2][75:75]+In2[2][75:75]+Bias[3]) +</div><div class="line">  (In1[3][75:75]+In2[3][75:50] + Bias[3]);</div></div><!-- fragment --><p>As you can see each matrix occupies 75 * 75 * 4 = 22.5 Kbytes. There are 4 of them for In1, 4 for In2 and 4 for Out so a total of 270Kbytes. Clearly this does not fit in the shared L1 memory. The GAP8 auto-tiler produces code that will transparently move sections of the 270Kbytes back and forth from L2 to shared L1 and make them available to the basic kernel function doing the actual calculation (our special matrix addition) making sure all the cores are always active.</p>
<h3><a class="anchor" id="section22"></a>
User kernel example - CNN convolution layer</h3>
<p>We assume 3 input data planes of size W x H and 2 output data planes of size W - 4 x H - 4 (padding is not performed). The diagram below gives a high-level view of what needs to be done.</p>
<div class="image">
<img src="images/cnn_convolution.png" alt="CNN Convolution"/>
</div>
<p>Since to get the result, we must sum up the convolution results from all input planes, we can also assume that we start the summation with a matrix made up of identical values, a bias. Planes contain fixed point numbers made up of 16 bits (short int).</p>
<p>Instead of having a specialized implementation, we want to allow the number of input and output data planes to be specified so we simply embed the user kernel in a C function with proper arguments.</p>
<p>Our 2 basic kernels are KerSetInBias that copies the same constant value in a matrix and KerDirectConv5x5_fp that takes care of the convolution itself. The convolution takes a 2D input In, a set of filter coefficients (25 in this case) and produces a 2D output. It performs normalization shifting the result by Norm.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> GenerateCnnConv5x5(<span class="keywordtype">char</span> *Name, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> InPlane,</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> OutPlane, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> W, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> H)</div><div class="line">{</div><div class="line">  <a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(Name,</div><div class="line">    KernelDimensions(InPlane, W, H, OutPlane),</div><div class="line">    KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4caed92cdcd78693866bbd9f0ab0198afc4">KER_DIM4</a>, KER_OUT_PLANE, KER_TILE, KER_IN_PLANE),</div><div class="line">    <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258a42bffded6e7107d8c7f2570b28748ba5">TILE_HOR</a>,</div><div class="line">    <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(5,</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;short int * __restrict__&quot;</span>, <span class="stringliteral">&quot;In&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;short int * __restrict__&quot;</span>, <span class="stringliteral">&quot;Filter&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;short int * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;unsigned int&quot;</span>,             <span class="stringliteral">&quot;Norm&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;short int * __restrict__&quot;</span>, <span class="stringliteral">&quot;Bias&quot;</span>)</div><div class="line">    ),</div><div class="line">    <a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(2,</div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;KerSetInBias&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#ga6adbece916d3475b218a80ed441e4342">LOC_IN_PLANE_PROLOG</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(4,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#gaf3226f1f3741f134ff6843de3bdf1d4e">C_ArgIndex</a>(<span class="stringliteral">&quot;Bias&quot;</span>, KER_OUT_PLANE, 1)</div><div class="line">        )</div><div class="line">      ),</div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;KerDirectConv5x5_fp&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(6,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Filter&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Norm&quot;</span>)</div><div class="line">        )</div><div class="line">      )</div><div class="line">    ),</div><div class="line">    <a class="code" href="group__UserKArg.html#gafdb4098fb8678d382b89763924cc3499">KerArgs</a>(3,</div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;In&quot;</span>, OBJ_IN_DB_3D, W, H, <span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>), 5-1, 0, 0, <span class="stringliteral">&quot;In&quot;</span>, 0),</div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;Filter&quot;</span>, OBJ_IN_DB_NTILED_4D, 5, 5,</div><div class="line">        <span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>), 0, 0, 0, <span class="stringliteral">&quot;Filter&quot;</span>, 0),</div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;Out&quot;</span>, OBJ_OUT_DB_3D, W-5+1, H-5+1,</div><div class="line">        <span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>), 0, 0, 0, <span class="stringliteral">&quot;Out&quot;</span>, 0)</div><div class="line">    )</div><div class="line">  );</div><div class="line">}</div></div><!-- fragment --><p>This example illustrates:</p>
<ul>
<li>3D and 4D user kernel arguments</li>
<li>Multi-buffered in and out</li>
<li>Overlapping tiles (first argument)</li>
<li>Untiled arguments (second argument). We need this because the filter applies to the entire input data plane not to a given point in it</li>
<li>Calling several basic kernels at different steps in the iteration. Setting the bias must be performed before we start producing the series of convolutions e.g before we start traversing the input planes hence in <code>LOC_IN_PLANE_PROLOG</code>. The convolution itself must be performed on every single tile so it is in the inner loop.</li>
<li>Bindings to user kernel arguments tiles and tile attributes (<code><a class="el" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065" title="Binds argument to a user kernel argument (a tiled argument). ">K_Arg()</a></code>)</li>
<li>Bindings to user kernel C arguments either as plain scalar (<code><a class="el" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7" title="Binds argument to a C user kernel or user kernel group. ">C_Arg()</a></code>) or as plane indexed (<code><a class="el" href="group__ArgBind.html#gaf3226f1f3741f134ff6843de3bdf1d4e" title="Binds argument to a C user kernel or user kernel group subscripted by an Index. ">C_ArgIndex()</a></code>)</li>
</ul>
<h2><a class="anchor" id="section23"></a>
User kernel groups</h2>
<p>It is useful to decompose a user kernel into a group of connected user kernels. User kernel groups allow this.</p>
<p>A user kernel group is described by a set of 2 anchors around a list of user kernel definitions. The first anchor marks the beginning of the user kernel group and defines its name. The second anchor closes the group. Then a second section models the C kernel template for the group and how the user kernels in the user kernel group should be connected together.</p>
<p>Here is the API to open and to close a kernel group:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__KernelGroup.html#gad82abbdc72482cf1796b3617c6fba551">OpenKernelGroup</a>(</div><div class="line">  <span class="comment">// The name of the group, will be the name of the C template</span></div><div class="line">  <span class="comment">// generated for this group.</span></div><div class="line">  <span class="keywordtype">char</span> *GroupName</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__KernelGroup.html#gaff8140e9aab1065ba9f38088639d379b">CloseKernelGroup</a>();</div></div><!-- fragment --><p>To model a kernel group the API is:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__KernelGroup.html#ga314e530975667940b69b7b0403ed93fc">UserKernelGroup</a>(</div><div class="line">  <span class="comment">// The same name than the one used in OpenKernelGroup</span></div><div class="line">  <span class="keywordtype">char</span> *GroupName,</div><div class="line">  <span class="comment">// A list of C argunents created with CArgs(Count, ...)</span></div><div class="line">  <a class="code" href="structCKernel__Arg__T.html">CKernel_Arg_T</a> **Carg,</div><div class="line">  <span class="comment">// A list of user kernel calls created with Calls(Count, ...)</span></div><div class="line">  <a class="code" href="structCKernelCall__T.html">CKernelCall_T</a> **Ccalls</div><div class="line">);</div></div><!-- fragment --><p>As a reminder:</p>
<div class="fragment"><div class="line"><a class="code" href="structCKernel__Arg__T.html">CKernel_Arg_T</a> **<a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ArgCount,</div><div class="line">  ...  <span class="comment">// A list of TCArg()</span></div><div class="line">);</div><div class="line"></div><div class="line"><a class="code" href="structCKernel__Arg__T.html">CKernel_Arg_T</a> *<a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(</div><div class="line">  <span class="keywordtype">char</span> *ArgType,</div><div class="line">  <span class="keywordtype">char</span> *ArgName);</div><div class="line"></div><div class="line"><a class="code" href="structCKernelCall__T.html">CKernelCall_T</a> **<a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(</div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> CallCount,</div><div class="line">  ... <span class="comment">// A list of UserKernelCall()</span></div><div class="line">);</div></div><!-- fragment --><p>Instead of <code><a class="el" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5" title="Create a call to a basic or a user kernel. ">Call()</a></code> which is used to model a call to a basic kernel, we use <code><a class="el" href="group__KernelGroup.html#ga443a6e05a896c367ac20ee8ad1d46d43" title="Call a user kernel in a user kernel group. ">UserKernelCall()</a></code>. Its interface is the same as <code><a class="el" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5" title="Create a call to a basic or a user kernel. ">Call()</a></code> but it has some additional restrictions.</p>
<div class="fragment"><div class="line"><a class="code" href="structCKernelCall__T.html">CKernelCall_T</a> *<a class="code" href="group__KernelGroup.html#ga443a6e05a896c367ac20ee8ad1d46d43">UserKernelCall</a>(</div><div class="line">  <span class="keywordtype">char</span> *CallName,</div><div class="line">  <a class="code" href="group__AutoTilerTypes.html#gacfeda3b2985b27a751ebce59c4d821c7">KernelCallLocationT</a> CallLocation, <span class="comment">// Here can only be LOC_GROUP</span></div><div class="line">  <a class="code" href="structArgBindingDescr__T.html">ArgBindingDescr_T</a> **BindingList   <span class="comment">// Here only these 2 bindings</span></div><div class="line">  <span class="comment">// can be used: CArg() and Imm()</span></div><div class="line">);</div><div class="line"></div><div class="line"><a class="code" href="structArgBindingDescr__T.html">ArgBindingDescr_T</a> **<a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(</div><div class="line">  <span class="keywordtype">int</span> Bcount,</div><div class="line">  ... <span class="comment">// A list of bindings, CArg() and Imm() only in this context</span></div><div class="line">);</div><div class="line"></div><div class="line"><a class="code" href="structArgBindingDescr__T.html">ArgBindingDescr_T</a> *<a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>( <span class="keywordtype">char</span> *ArgName);</div><div class="line"></div><div class="line"><a class="code" href="structArgBindingDescr__T.html">ArgBindingDescr_T</a> *<a class="code" href="group__ArgBind.html#ga02e73d15bc6b3fb0d066738073dbc441">Imm</a>( <span class="keywordtype">int</span> Value);</div></div><!-- fragment --><p>Some details on the user kernel group call sequence:</p>
<ol type="1">
<li>By construction a user kernel group is made up of a sequential call to a sequence of user kernels so all calls will be performed by the cluster master core (core 0) only.</li>
<li>In user kernels, the call sequence is made up of basic kernels and each call is inserted at a provided location in the iteration structure. In a user kernel group, calls are only to user kernels and since there is no iteration structure in a group, the call location is <code>LOC_GROUP</code>.</li>
</ol>
<h3><a class="anchor" id="section24"></a>
User kernel group example, 2D FFT</h3>
<p>The input is a 2D byte pixel image of dimension Dim x Dim. Dim has to be a power of 2.</p>
<p>We first have to expand the input image into I/Q pairs. I and Q are the imaginary and real parts of a complex number, both represented as Q15 fixed point numbers in a short int. We use the <a class="el" href="FFTBasicKernels_8h.html#aa36e941c0a8f70d6f98aeb83f6fc5520">Image2Complex()</a> basic kernel. Tiling is horizontal.</p>
<p>Then we compute the FFT of each line of the expanded input, all the FFTs are independent. Therefore they can be evaluated in parallel. We use either a radix 4 or radix 2 FFT decimated in frequency (inputs in natural order, output in bit reverse order).</p>
<p>Finally, we reorder the FFT outputs with SwapSamples_2D_Horizontal_Par.</p>
<p>These 3 steps can be grouped together into a single user kernel in charge of the horizontal FFTs.</p>
<p>Once horizontal FFTs have been computed, we have to compute a 1D FFT on each column of the horizontally transformed input, so we use vertical tiling. Since the vertical FFT is also decimated in frequency, we have to reorder the vertical FFTs output. These 2 basic kernels are grouped into a single user kernel in charge of the vertical FFTs.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> FFT2D(<span class="keywordtype">char</span> *Name, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> Dim, <span class="keywordtype">int</span> ForceRadix2)</div><div class="line">{</div><div class="line">  <span class="keywordtype">char</span> *KerHorizontal, *KerVertical;</div><div class="line"></div><div class="line">  <span class="comment">// Dim is the dimension of the FFT, First select the right 1D FFT (Radix 2</span></div><div class="line">  <span class="comment">// or 4) depending on dim</span></div><div class="line">  <span class="keywordflow">if</span> (__builtin_popcount(Dim) != 1)</div><div class="line">    <a class="code" href="group__BookKeeping.html#gad110b18368975363a4cccf3f3b81824f">GenTilingError</a>(</div><div class="line">      <span class="stringliteral">&quot;FFT2D: %s, Incorrect Dim: %d, it has to be a a power of 2&quot;</span>, Name, Dim);</div><div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((__builtin_ctz(Dim)%2)==0) {</div><div class="line">    <span class="comment">/* Radix 4 FFT */</span></div><div class="line">    KerHorizontal = <span class="stringliteral">&quot;Radix4FFT_DIF_2D_Horizontal&quot;</span>;</div><div class="line">    KerVertical = <span class="stringliteral">&quot;Radix4FFT_DIF_2D_Vertical&quot;</span>;</div><div class="line">  } <span class="keywordflow">else</span> {</div><div class="line">    <span class="comment">/* Radix 2 FFT */</span></div><div class="line">    KerHorizontal = <span class="stringliteral">&quot;Radix2FFT_DIF_2D_Horizontal&quot;</span>;</div><div class="line">    KerVertical = <span class="stringliteral">&quot;Radix2FFT_DIF_2D_Vertical&quot;</span>;</div><div class="line">  }</div><div class="line">  <span class="comment">// Here we open the kernel group</span></div><div class="line">  <a class="code" href="group__KernelGroup.html#gad82abbdc72482cf1796b3617c6fba551">OpenKernelGroup</a>(Name);</div><div class="line">  <span class="comment">// First user kernel in the group.</span></div><div class="line">  <span class="comment">// The group input is a byte image, we have to expand it to a</span></div><div class="line">  <span class="comment">// complex representation (I and Q in Q15).</span></div><div class="line">  <span class="comment">// Then we perform a 1D FFT on each line of the expanded input</span></div><div class="line">  <span class="comment">// Finally we reorder the FFT output</span></div><div class="line">  <a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<a class="code" href="group__BookKeeping.html#ga40f1e8d762a9f92eb9b2b3808ce71e76">AppendNames</a>(Name, <span class="stringliteral">&quot;Horizontal&quot;</span>),</div><div class="line">    KernelDimensions(1, Dim, Dim, 1),</div><div class="line">    KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4ca82ed5e72b32c8ab2049c97335bf47146">KER_DIM2</a>, KER_TILE),</div><div class="line">    <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258a42bffded6e7107d8c7f2570b28748ba5">TILE_HOR</a>,</div><div class="line">    <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(4,</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Wordu8 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;v2s * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word16 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Twiddles&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word16 * __restrict__&quot;</span>, <span class="stringliteral">&quot;SwapTable&quot;</span>)</div><div class="line">    ),</div><div class="line">    <a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(3,</div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;Image2Complex&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(4,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>))),</div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(KerHorizontal, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(4,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Twiddles&quot;</span>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>))),</div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;SwapSamples_2D_Horizontal_Par&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(4,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;SwapTable&quot;</span>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>)))</div><div class="line">    ),</div><div class="line">    <a class="code" href="group__UserKArg.html#gafdb4098fb8678d382b89763924cc3499">KerArgs</a>(2,</div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;In&quot;</span>,  <a class="code" href="group__AutoTilerTypes.html#gga1e3ffc7438780fc2a3a08eca121a3de5a40a3c67e7f0a9c49945c4272d4f06de3">OBJ_IN_DB</a>,  Dim, Dim, <span class="keyword">sizeof</span>(Wordu8),  0, 0, 0, <span class="stringliteral">&quot;In&quot;</span>, 0),</div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;Out&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga1e3ffc7438780fc2a3a08eca121a3de5a1c6e33b16f9642289efd871255a3608b">OBJ_OUT_DB</a>, Dim, Dim, <span class="keyword">sizeof</span>(Word32),  0, 0, 8, <span class="stringliteral">&quot;Out&quot;</span>, 0)</div><div class="line">    )</div><div class="line">  );</div><div class="line">  <span class="comment">// Second user kernel in the group.</span></div><div class="line">  <span class="comment">// This user kernel takes as an input the output of the horizontal FFT step</span></div><div class="line">  <span class="comment">// It performs a 1D FFT on each column of the input matrix (note that here</span></div><div class="line">  <span class="comment">// the tiling is vertical)</span></div><div class="line">  <span class="comment">// Finally we reorder the FFT output and we are done</span></div><div class="line">  <a class="code" href="group__UserK.html#ga163233141ddce3e65fe5c97ea52d4bc3">UserKernel</a>(<a class="code" href="group__BookKeeping.html#ga40f1e8d762a9f92eb9b2b3808ce71e76">AppendNames</a>(Name, <span class="stringliteral">&quot;Vertical&quot;</span>),</div><div class="line">    KernelDimensions(1, Dim, Dim, 1),</div><div class="line">    KernelIterationOrder(<a class="code" href="group__AutoTilerTypes.html#ggabd6265f860d20f2441d79c2261b22e4ca82ed5e72b32c8ab2049c97335bf47146">KER_DIM2</a>, KER_TILE),</div><div class="line">    <a class="code" href="group__AutoTilerTypes.html#gga57ccb2b0bd6aae9142731ac85849e258aeb8c3a7c416d01316da2347e8ee9dd3b">TILE_VER</a>,</div><div class="line">    <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(3,</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word16 * __restrict__&quot;</span>, <span class="stringliteral">&quot;InOut&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word16 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Twiddles&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word16 * __restrict__&quot;</span>, <span class="stringliteral">&quot;SwapTable&quot;</span>)</div><div class="line">    ),</div><div class="line">    <a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(2,</div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(KerVertical, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(4,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;InOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Twiddles&quot;</span>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;InOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;InOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>))),</div><div class="line">      <a class="code" href="group__Calls.html#ga2b1212efe688f4bd57a6b2af337b58d5">Call</a>(<span class="stringliteral">&quot;SwapSamples_2D_Vertical_Par&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gab01d39a603ee6939a0cf40041b20f032">LOC_INNER_LOOP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(4,</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;InOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239ada5e76d62fac4070da48297125ff087a2c">KER_ARG_TILE</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;SwapTable&quot;</span>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;InOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adadf9c42517fa34e04899d074ff9aa1090">KER_ARG_TILE_H</a>),</div><div class="line">          <a class="code" href="group__ArgBind.html#ga5c79c141f9c5d30f001cbe23c012d065">K_Arg</a>(<span class="stringliteral">&quot;InOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga6ff2f68f8c0a0e967ef79828f94239adaa48746047ed65f1f687ed222ec90c950">KER_ARG_TILE_W</a>)))</div><div class="line">    ),</div><div class="line">    <a class="code" href="group__UserKArg.html#gafdb4098fb8678d382b89763924cc3499">KerArgs</a>(1,</div><div class="line">      <a class="code" href="group__UserKArg.html#ga2eda79e625467840fe7a0c0e43bbd33f">KerArg</a>(<span class="stringliteral">&quot;InOut&quot;</span>, <a class="code" href="group__AutoTilerTypes.html#gga1e3ffc7438780fc2a3a08eca121a3de5abe6273831df151e5b97dd77cbaf68ab7">OBJ_IN_OUT_DB</a>, Dim, Dim, <span class="keyword">sizeof</span>(Word32), 0, 0, 8, <span class="stringliteral">&quot;InOut&quot;</span>, 0)</div><div class="line">    )</div><div class="line"></div><div class="line">  );</div><div class="line">  <span class="comment">// The kernel group is closed</span></div><div class="line">  <a class="code" href="group__KernelGroup.html#gaff8140e9aab1065ba9f38088639d379b">CloseKernelGroup</a>();</div><div class="line"></div><div class="line">  <span class="comment">// Now we model the kernel group C template, then we provide the list of</span></div><div class="line">  <span class="comment">// user calls, in this case horizontal and vertical FFT and we model the</span></div><div class="line">  <span class="comment">// bindings between user kernel group C arguments and the 2 called</span></div><div class="line">  <span class="comment">// user kernels in the group</span></div><div class="line">  <a class="code" href="group__KernelGroup.html#ga314e530975667940b69b7b0403ed93fc">UserKernelGroup</a>(Name,</div><div class="line">    <a class="code" href="group__CArgs.html#ga963d1fb53bb2dd1a616aa6fc057f39fb">CArgs</a>(4,</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Wordu8 * __restrict__&quot;</span>, <span class="stringliteral">&quot;In&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word32 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Out&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word16 * __restrict__&quot;</span>, <span class="stringliteral">&quot;Twiddles&quot;</span>),</div><div class="line">      <a class="code" href="group__CArgs.html#ga70931c197d7e5f46eab1cb2c1c879d8b">TCArg</a>(<span class="stringliteral">&quot;Word16 * __restrict__&quot;</span>, <span class="stringliteral">&quot;SwapTable&quot;</span>)</div><div class="line">    ),</div><div class="line">    <a class="code" href="group__Calls.html#ga6a4f4c72f554436c762a8eba84003305">Calls</a>(2,</div><div class="line">      <a class="code" href="group__KernelGroup.html#ga443a6e05a896c367ac20ee8ad1d46d43">UserKernelCall</a>(<a class="code" href="group__BookKeeping.html#ga40f1e8d762a9f92eb9b2b3808ce71e76">AppendNames</a>(Name, <span class="stringliteral">&quot;Horizontal&quot;</span>), <a class="code" href="group__AutoTilerTypes.html#ggacfeda3b2985b27a751ebce59c4d821c7a42508ea49e1b5a7325bb597ec2585665">LOC_GROUP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(4, <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;In&quot;</span>), <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>), <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Twiddles&quot;</span>), <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;SwapTable&quot;</span>))),</div><div class="line">      <a class="code" href="group__KernelGroup.html#ga443a6e05a896c367ac20ee8ad1d46d43">UserKernelCall</a>(<a class="code" href="group__BookKeeping.html#ga40f1e8d762a9f92eb9b2b3808ce71e76">AppendNames</a>(Name, <span class="stringliteral">&quot;Vertical&quot;</span>),   <a class="code" href="group__AutoTilerTypes.html#ggacfeda3b2985b27a751ebce59c4d821c7a42508ea49e1b5a7325bb597ec2585665">LOC_GROUP</a>,</div><div class="line">        <a class="code" href="group__ArgBind.html#ga6cdaec59a8321bc979bd52570e34d4b3">Bindings</a>(3, <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Out&quot;</span>), <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;Twiddles&quot;</span>), <a class="code" href="group__ArgBind.html#ga511ba4603d53c739d6e3eaca5e0672e7">C_Arg</a>(<span class="stringliteral">&quot;SwapTable&quot;</span>)))</div><div class="line">    )</div><div class="line">  );</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="section25"></a>
Controlling tiled code generation</h2>
<p>As already mentioned a model is just a C program. To get the generated code you need to compile and execute the model.</p>
<p>The model makes use of the GAP8 auto-tiler library calls for which a header file needs to be included and a library to be added to the link list. All interfaces and data types are declared in <code><a class="el" href="AutoTilerLib_8h.html">AutoTilerLib.h</a></code> and the library itself is <code>AutoTilerLib.a</code>.</p>
<p>Below is a simple example of a complete generator using the auto-tiler, <code>MyProgram.c</code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="AutoTilerLib_8h.html">AutoTilerLib.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MySetOfUserKernels(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> L1_Memory_Budget)</div><div class="line">{</div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">    Here you include:</span></div><div class="line"><span class="comment">      Loading basic kernel libraries</span></div><div class="line"><span class="comment">      List of user kernels and user kernels groups</span></div><div class="line"><span class="comment">  */</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> ConfigureTiler()</div><div class="line">{</div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">    Here you include</span></div><div class="line"><span class="comment">    header files for the basic kernels</span></div><div class="line"><span class="comment">    Files to be produced</span></div><div class="line"><span class="comment">    Tiler options</span></div><div class="line"><span class="comment">    ...</span></div><div class="line"><span class="comment">  */</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">  <span class="comment">// First use library API to parse program options and initialize the tile</span></div><div class="line">  <span class="keywordflow">if</span> (<a class="code" href="group__CompFC.html#ga9afe5953768a3b21f9d2f616a398d124">TilerParseOptions</a>(argc, argv)) {</div><div class="line">    printf(<span class="stringliteral">&quot;Failed to initialize or incorrect arguments.\n&quot;</span>); <span class="keywordflow">return</span> 1;</div><div class="line">  }</div><div class="line">  <span class="comment">// Setup Gap8 auto tiler preferences</span></div><div class="line">  ConfigureTiler();</div><div class="line">  <span class="comment">// Then call the function in which the user kernel models are, we give 51200 bytes of</span></div><div class="line">  <span class="comment">// memory as a budget</span></div><div class="line">  MySetOfUserKernels(51200);</div><div class="line">  <span class="comment">// Now that the model is built we produce code for it</span></div><div class="line">  <a class="code" href="group__CompFC.html#ga67d451563006329849eb32d6e2de675d">GenerateTilingCode</a>();</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>To compile and use the sample:</p>
<div class="fragment"><div class="line">gcc</div><div class="line">  -o MyGenerator</div><div class="line">  -I&lt;path to where tiler libs h files are&gt;</div><div class="line">  MyModel.c</div><div class="line">  -L&lt;path to where the tiler lib is&gt;AutoTilerLib.a</div></div><!-- fragment --><p>And run MyGenerator to have the tiled user kernels generated:</p>
<div class="fragment"><div class="line">./MyGenerator</div></div><!-- fragment --><p>The GAP8 auto-tiler uses and produces files, the general scheme is illustrated below:</p>
<div class="image">
<img src="images/workflow.png" alt="Auto-tiler work-flow"/>
</div>
<p><code>OptionalBasicKernelLibn.h</code> : This is where the C templates for the basic kernels are expected to be found for proper compilation of the generated code. Both the C templates as well as the struct typedefs for the basic kernel arguments are included. It can be empty.</p>
<p><code>KernelLibStdTypes.h</code> : Contains some internal tiler argument types definitions. This is the default name but it can be redefined.</p>
<p>The API to redefine KernelLibStdTypes.h and to provide which basic kernel libraries to use is the following:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__CompFC.html#ga9c783e7e0424d67855208298d62bc051">SetUsedFilesNames</a>(</div><div class="line">  <span class="comment">/* To redefine  KernelLibStdTypes.h, if 0 uses default */</span></div><div class="line">  <span class="keywordtype">char</span> StdTypedefsName,</div><div class="line">  <span class="comment">/* Number of basic kernel libraries to be passed */</span></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> LibKernelFileCount,</div><div class="line">  <span class="comment">/* List of basic kernel libraries passed as strings */</span>  </div><div class="line">  ...         </div><div class="line">  )</div></div><!-- fragment --><p>Four files are produced by the auto tiler</p>
<p><code>GenKernels.c</code> : The generated code for all user kernels and groups in the model</p>
<p><code>GenKernels.h</code> : Include file for the generated code</p>
<p><code>GenKernelsInit.c</code> : Some variable definitions</p>
<p><code>GenKernelsInit.h</code> : Include file for the initialization code</p>
<p>The names used here are the default names, they can be overridden using the following function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__CompFC.html#ga07d945778f420e4188a570055f6b02e5">SetGeneratedFilesNames</a>(</div><div class="line">  <span class="keywordtype">char</span> *ArgInitsName,    <span class="comment">/* Redefinition of GenKernelsInit.c */</span></div><div class="line">  <span class="keywordtype">char</span> *ArgInitsHeaderName,   <span class="comment">/* Redefinition of GenKernelsInit.h */</span></div><div class="line">  <span class="keywordtype">char</span> *CallTemplatesName,    <span class="comment">/* Redefinition of GenKernels.c */</span></div><div class="line">  <span class="keywordtype">char</span> *CallTemplatesNameHeader <span class="comment">/* Redefinition of GenKernels.h */</span></div><div class="line">)</div></div><!-- fragment --><p>Four other symbols are also manipulated by the auto tiler:</p>
<p><code>L1_Memory</code> : One symbol, a pointer or an array, in which all the tiles generated by the tiler will be allocated in the shared L1 memory.</p>
<p><code>L2_Memory</code> : One symbol, a pointer or an array, in which all the tiles generated by the tiler will be allocated in the L2 memory.</p>
<p><code>AllKernels</code> : One symbol, an array, in which user kernel descriptor is stored. Descriptors are generated only when user kernels are not inlined.</p>
<p><code>AllKernelsArgs</code> : One symbol, an array, in which user kernel arguments descriptors are stored, AllKernels will point into it. These descriptors are generated only when user kernels are not in-lined.</p>
<p>These 4 names are default names, they can changed with the following function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__CompFC.html#gaf0a3370071599c37981130129297b53a">SetSymbolNames</a>(</div><div class="line">  <span class="keywordtype">char</span> *L1SymbName,  </div><div class="line">  <span class="keywordtype">char</span> *L2SymbName,</div><div class="line">  <span class="keywordtype">char</span> *KernelDescrName,</div><div class="line">  <span class="keywordtype">char</span> *KernelDescArgName</div><div class="line">)</div></div><!-- fragment --><p>By default these 4 symbols are managed as arrays, you can make them dynamic (pointers) in order to have the memory allocated and deallocated dynamically. The execution log of the auto tiler tells you the number of bytes to be allocated for each of them.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__CompFC.html#gacdfcd173c7559f6cc1fea70356f48cc9">SetSymbolDynamics</a>()</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Jan 24 2020 12:47:55 for  by GreenWaves Technologies
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 
	-->
	</li>
  </ul>
</div>
</body>
</html>
