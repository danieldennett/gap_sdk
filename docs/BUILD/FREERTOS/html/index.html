<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FreeRTOS port on GAP8</title>
<title>FreeRTOS port on GAP8</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="pulp.css" rel="stylesheet" type="text/css" />
<link href="gap.css" rel="stylesheet" type="text/css" />
<link href="images.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="titlerow">
  <td id="projectlogo"><img alt="Logo" src="gap-logo-55.png" /></td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">FreeRTOS port on GAP8/RISC-V</div>
    </td>
  <td id="extralogo"><img alt="GreenWaves" src="greenwaves-logo-55.png" /></td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">FreeRTOS port on GAP8 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Allocate memory from an allocator.</p><ul>
<li></li>
</ul>
<h1><a class="anchor" id="section0"></a>
Introduction</h1>
<div class="image">
<img src="images/freertos.png" alt="FreeRTOS" title="FreeRTOS"/>
</div>
<p>FreeRTOS is an RTOS designed for small and resource constrained micro-controllers, issued under MIT license. It was developed and maintained, since 2003, by Richard Barry and his Real Time Engineers Ltd. It is now under the aegis of <a href="https://aws.amazon.com/blogs/opensource/announcing-freertos-kernel-v10/">Amazon Web Services</a> and became Amazon FreeRTOS since 2017. FreeRTOS still remains available under MIT license. Light and easily configurable, it supports multi-tasking, various synchronization mechanism and communication between tasks, and various others features. You may refer to the official website to learn more about <a href="https://www.freertos.org/FreeRTOS_Features.html">FreeRTOS and its features</a>.</p>
<p>## FreeRTOS Structure {#section1} </p><div class="fragment"><div class="line">freeRTOS</div><div class="line">├── demos</div><div class="line">|   └── gwt                            --- &quot;Hello World&quot; demo</div><div class="line">├── freertos_kernel                    --- FreeRTOS kernel source code</div><div class="line">|    ├── include                       --- FreeRTOS kernel headers and macros</div><div class="line">|    ├── License                       --- FreeRTOS License file</div><div class="line">|    └── portable                      --- FreeRTOS port source files</div><div class="line">└── vendors                            --- Vendors specific drivers and libraries</div><div class="line">     └── gwt</div></div><!-- fragment --><p>FreeRTOS is a small kernel for embedded systems. To make use of GAP8 and GAPUINO, a stack has been added between the kernel and the hardware as follows.</p>
<div class="image">
<img src="images/freertos_stack_cropped.png" alt="FreeRTOS Structure" title="FreeRTOS Stacks"/>
</div>
<p>The GAP8 stack makes use of <a href="https://github.com/GreenWaves-Technologies/pmsis_api">PMSIS_API</a>.</p>
<h2><a class="anchor" id="section2"></a>
Port details</h2>
<p>The port essentially concerns 3 files : </p><div class="fragment"><div class="line">&lt;SUB&gt;/gap_sdk/rtos/freeRTOS$ tree freertos_kernel/portable/GCC/RI5CY-GAP8/</div><div class="line">freertos_kernel/portable/GCC/RI5CY-GAP8/</div><div class="line">├── chip_specific_extensions           --- RISC-V chips extensions definitions and macros</div><div class="line">│   └── gap8                           --- GAP8 extensions</div><div class="line">│       └── freertos_risc_v_chip_specific_extensions.h</div><div class="line">├── port_asm.S                         --- Functions written in RISC-V assembly</div><div class="line">├── port.c                             --- Functions needed for the port</div><div class="line">└── portmacro.h                        --- macros used for the port</div></div><!-- fragment --><h1><a class="anchor" id="section3"></a>
Hello World test</h1>
<p>In <em>demos</em> folder, there is a simple there is a simple "Hello World" example for FreeRTOS. Before trying this example, the shell environment shall be configured. To do so, start a terminal and navigate to <em>gap_sdk</em> folder and then execute <code>source</code> command. When prompted, select GAP8(1) or GAP8_V2(2) : </p><div class="fragment"><div class="line">&lt;SUB&gt;/gap_sdk$ source sourceme.sh</div><div class="line">Which chip you want to use: 1-GAP8 2-GAP8_V2 [1]: 1</div><div class="line">The target chip you have chosen is : GAP8</div></div><!-- fragment --><p>Then navigate to the 'HelloWorld' demo and execute the following command : </p><div class="fragment"><div class="line">&lt;SUB&gt;/gap_sdk$ cd freeRTOS/demos/gwt/gap8/common/application_code/</div><div class="line">&lt;SUB&gt;/gap_sdk/freeRTOS/demos/gwt/gap8/common/application_code$ make clean all run</div></div><!-- fragment --><p>You should get this as the output </p><div class="fragment"><div class="line">         *** FreeRTOS HelloWorld ***</div><div class="line"></div><div class="line">Entering main controller</div><div class="line">[32 0] Hello World!</div><div class="line">Detected end of application, exiting with status: 0</div></div><!-- fragment --><h2><a class="anchor" id="section4"></a>
Hello World Explanation:</h2>
<div class="fragment"><div class="line"><span class="comment">/* PMSIS includes */</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="pmsis_8h.html">pmsis.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="comment">/* Variables used. */</span></div><div class="line"><a class="code" href="core__gap__memory__define_8h.html#abf9bcb330bc7a25a6f749677b6bd6f5f">PI_L2</a> <span class="keywordtype">char</span> <a class="code" href="helloworld_8c.html#a922fc346b552763c42c1fa13fe63d723">hello</a>[20];</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="helloworld_8c.html#af250aa21a5bda88a24025412ae8ac061">helloworld</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="printf_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9">printf</a>(<span class="stringliteral">&quot;Entering main controller\n&quot;</span>);</div><div class="line">    uint32_t errors = 0;</div><div class="line">    uint32_t core_id = <a class="code" href="pmsis__targets_8h.html#ad2601999c360bae78c441a46a669da40">pi_core_id</a>(), cluster_id = <a class="code" href="pmsis__targets_8h.html#a30c3230e324070c31703864704b5e785">pi_cluster_id</a>();</div><div class="line"></div><div class="line">    <a class="code" href="printf_8h.html#a5998f60c4f4af322b36debdbd11d7917">sprintf</a>(<a class="code" href="helloworld_8c.html#a922fc346b552763c42c1fa13fe63d723">hello</a>, <span class="stringliteral">&quot;[%d %d] Hello World!\n&quot;</span>, cluster_id, core_id);</div><div class="line">    <a class="code" href="printf_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9">printf</a>(<a class="code" href="helloworld_8c.html#a922fc346b552763c42c1fa13fe63d723">hello</a>);</div><div class="line"></div><div class="line">    <a class="code" href="pmsis__task_8h.html#aed4de0c7c94520070758fca10583b589">pmsis_exit</a>(errors);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Program Entry. */</span></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="printf_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9">printf</a>(<span class="stringliteral">&quot;\n\n\t *** FreeRTOS HelloWorld *** \n\n&quot;</span>);</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="pmsis__os_8h.html#a1c5bf710b18f18aca16369e92464d731">pmsis_kickoff</a>((<span class="keywordtype">void</span> *) <a class="code" href="helloworld_8c.html#af250aa21a5bda88a24025412ae8ac061">helloworld</a>);</div><div class="line">}</div></div><!-- fragment --><p>This helloworld example has 2 functions : <code><a class="el" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></code> and <code><a class="el" href="helloworld_8c.html#af250aa21a5bda88a24025412ae8ac061">helloworld()</a></code>. The <code><a class="el" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></code> function is used to create threads, kernel objects(semaphore, mutex,...), and start the scheduler. Once the scheduler has started, there is no return to the <code><a class="el" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></code> function. Therefore, if you need to share variables or objects between tasks, do not instantiate inside the <code><a class="el" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></code> function. <code><a class="el" href="helloworld_8c.html#af250aa21a5bda88a24025412ae8ac061">helloworld()</a></code> is the actual function printing "Hello World". The created task's core function.</p>
<ul>
<li>The stack size must suit the application. Here the macro <code>configMINIMAL_STACK_SIZE</code> is used to indicate the minimal stack size for the Idle Task(task with the lowest priority, 0). Stack overflow can be checked during runtime by the kernel if <code>configCHECK_FOR_STACK_OVERFLOW</code> is set in <em><a class="el" href="FreeRTOSConfig_8h.html">FreeRTOSConfig.h</a></em>. If <code>configCHECK_FOR_STACK_OVERFLOW</code> is set, a hook function must be defined by the user. The released FreeRTOS is set to check overflows and the associated hook function is defined in <em>FreeRTOS_util.c</em>. The program is terminated in case of stack overflow. You are free to edit it to suit your application.</li>
<li>The task priority can be set between the Idle Task priority and <code>configMAX_PRIORITIES</code> - 1.</li>
<li>A <code>Task handler</code> is always linked to a task. It can be used to stop, resume or kill a task by another one.</li>
</ul>
<p>More details on task creation are available <a href="https://www.freertos.org/a00019.html">here</a> and <a href="https://www.freertos.org/a00106.html">FreeRTOS API Reference</a>.</p>
<p>If the task creation is successful, the scheduler can then be called. From here on, the <code><a class="el" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></code> function is not reachable.</p>
<p>In <code>vTestHelloWorld()</code>, the task prints "Hello World" with its name, core ID and cluster ID. When it is done, the task suspends its execution( <code>vTaskSuspend( NULL )</code> ) and the Idle task takes place on the core and cleans memory allocated for the deleted task. When a task is deleted using <code>vTaskDelete( taskHandle )</code>, the Idle task must not be starved of processing time to free allocated memory. The <em>Idle Task hook</em> should not use any blocking API.</p>
<p>In the released FreeRTOS, <em>Idle Task hook</em> is used to get details of tasks or delete suspended tasks. Once again, you may edit <em>FreeRTOS_util.c</em> to your convenience.</p>
<h2><a class="anchor" id="section5"></a>
Use uart for printf</h2>
<p>Console through uart will be triggered by flag PRINTF_UART, which should be add in the user makefile:</p>
<div class="fragment"><div class="line">FREERTOS_FLAGS += -DPRINTF_UART=1</div><div class="line"># or {#section6}</div><div class="line">APP_CFLAGS     += -DPRINTF_UART=1</div></div><!-- fragment --><h1><a class="anchor" id="section7"></a>
FreeRTOS Scheduler</h1>
<p>Tasks in FreeRTOS are classified in 4 states :</p><ul>
<li><b>Running</b> : Task is currently using the core.</li>
<li><b>Ready</b> : Task is in ready list, ready to take place on the core.</li>
<li><b>Blocked</b> : Task is waiting for an event. Task can be in this state if the task has called <code><a class="el" href="freertos__kernel_2include_2task_8h.html#aa154068cecd7f31446a7a84af44ab1a3">vTaskDelay()</a></code> function, or if a non-null timeout has been defined when the task was waiting for a semaphore, mutex or queue and is not yet available. If the timeout is reached and the object is not available, the task enters in <b>Ready</b> state.</li>
<li><b>Suspended</b> : Same as the <b>Blocked</b> state, but without timeout. <code><a class="el" href="freertos__kernel_2include_2task_8h.html#a84d4e660b04630be2939d91b3c2412f8">vTaskSuspend()</a></code> and <code>xTaskResume()</code> are the API calls to get in and out of this state.</li>
</ul>
<p>The states transition diagram is given below. </p><div class="image">
<img src="https://www.freertos.org/tskstate.gif" alt="Task State" title="FreeRTOS task states transition diagram"/>
</div>
<p>.</p>
<p>FreeRTOS scheduler is preemptive, with Round-Robin policy. User can modify its behaviour with <code>configUSE_PREEMPTION</code> and <code>configUSE_TIME_SLICING</code>, <em><a class="el" href="FreeRTOSConfig_8h.html">FreeRTOSConfig.h</a></em>.</p>
<ul>
<li><code>configUSE_PREEMPTION</code> = 0 :<ul>
<li>Preemptive mode disabled. Tasks take place on core when<ul>
<li>the running task enters <b>Blocked</b> or <b>Suspended</b> state</li>
<li>the running task explicitly leaves the core when calling <code><a class="el" href="freertos__kernel_2include_2task_8h.html#a767e474430db1e60056e9678763f9202">taskYIELD()</a></code></li>
</ul>
</li>
</ul>
</li>
<li><code>configUSE_PREEMPTION</code> = 1 :<ul>
<li><p class="startli"><code>configUSE_TIME_SLICING</code> = 0 :</p>
<p class="startli">Preemptive mode enabled without time slicing, i.e processing time(quantum) will not be equal between tasks. Tasks are preempted from the core if</p><ul>
<li>a higher priority task enters <b>Ready</b> state</li>
<li>the running task enters <b>Blocked</b> or <b>Suspended</b> state</li>
<li>the running task explicitly leaves the core when calling <code><a class="el" href="freertos__kernel_2include_2task_8h.html#a767e474430db1e60056e9678763f9202">taskYIELD()</a></code></li>
</ul>
</li>
<li><p class="startli"><code>configUSE_TIME_SLICING</code> = 1 :</p>
<p class="startli">Preemptive mode enabled with time slicing, i.e equal processing time between tasks of equal priority. Tasks are preempted from the core if</p><ul>
<li>one or more tasks of equal priority are in <b>Ready</b> state.</li>
<li>a higher priority task enters <b>Ready</b> state</li>
<li>the running task enters <b>Blocked</b> or <b>Suspended</b> state</li>
<li>the running task explicitly leaves the core when calling <code><a class="el" href="freertos__kernel_2include_2task_8h.html#a767e474430db1e60056e9678763f9202">taskYIELD()</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>FreeRTOS is released with preemptive mode and time slicing enabled.</p>
<h1><a class="anchor" id="section8"></a>
Memory allocation</h1>
<h2><a class="anchor" id="section9"></a>
Memory locations</h2>
<p>On GAP8, there are 3 locations for data storage :</p>
<table class="doxtable">
<tr>
<th align="center">Name </th><th align="center">Address </th><th align="center">Size </th><th align="center">Type  </th></tr>
<tr>
<td align="center">L2_RAM </td><td align="center">0x1C000000 </td><td align="center">512kB </td><td align="center">Primary memory used for both data and instructions storage </td></tr>
<tr>
<td align="center">FC_TCDM </td><td align="center">0x1B000000 </td><td align="center">16kB </td><td align="center">Memory used by Fabric Controller for fast access </td></tr>
<tr>
<td align="center">L1_TCDM </td><td align="center">0x10000000 </td><td align="center">64kB </td><td align="center">Shared memory between Feature Cluster cores </td></tr>
</table>
<h2><a class="anchor" id="section10"></a>
Malloc implementations</h2>
<p>FreeRTOS offers 5 algorithms to allocate memory.</p>
<p><code>configSUPPORT_DYNAMIC_ALLOCATION</code> must be set in order to use the following malloc implementations.</p><ul>
<li><b>heap_1</b> : Simplest implementation of <code><a class="el" href="FreeRTOSConfig_8h.html#a4d523dc6c079459faa62130465595246">pvPortMalloc( size )</a></code>, malloc function. The requirements to use this implementation : memory size, defined with <code>configTOTAL_HEAP_SIZE</code>, and an array for the heap if <code>configAPPLICATION_ALLOCATED_HEAP</code> is set. This implementation allows memory allocation but does not allow to free the allocated memory.</li>
<li><b>heap_2</b> : Same requirements as of heap_1. This implementation allows allocated memory to be freed, but does not combine adjacent free blocks into a single larger one, so the memory is likey to be fragmented.</li>
<li><b>heap_3</b> : This implementation is simply a wrapper of the compiler's malloc and free functions. No requirements are needed.</li>
<li><b>heap_4</b> : Same requirements as of heap_1. This implementation is similar to heap_2, but this one combines adjacent free blocks into a larger one.</li>
<li><b>heap_5</b> : This implementation requires memory regions for memory allocation. A memory region is defined by the start address of the memory region and its size. Several memory regions can be defined to allocate memory. Memory region initialization must occur before any memory allocation. It is done by a call to <code>vPortDefineHeapRegions( xHeapRegions )</code> function. In <code><a class="el" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></code>, this call should be the first instruction, before task creation.</li>
</ul>
<p>In order to optimize memory allocations, we have added our own memory allocation implementation. You can find it in <em>rtos/pmsis/pmsis_driver/pmsis_malloc/malloc_internal.c</em>. It is a simple allocator which do not keep metadata used to allocate memory. Therefore this implementation requires, to free an allocated memory block, a pointer to the block to free along with its size.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="keywordtype">void</span> *<a class="code" href="group__malloc.html#gac0b788dee06cd6ebbd488476ac66c400">__malloc</a>(<a class="code" href="structmalloc__t.html">malloc_t</a> *a, int32_t size);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__malloc.html#ga2b72a354dec32d5ca48e3ae4b5ebfa4f">__malloc_free</a>(<a class="code" href="structmalloc__t.html">malloc_t</a> *a, <span class="keywordtype">void</span> *_chunk, int32_t size);</div></div><!-- fragment --><p> All three memory allocation(in memory locations previously mentionned) strategies rely on this implementation.</p>
<p>If this implementation does not suit your application, you may switch for another implementation or use compiler's implementation. In that case, you will have to edit the Makefile rules(<em>freeRTOS_rules.mk</em>) to add/remove the correct heap implementation in order to compile the project.</p>
<h2><a class="anchor" id="section11"></a>
GAP8 Memory allocations</h2>
<p>In GAP8, it is possible to allocate memory in each of the 3 memory locations.</p>
<table class="doxtable">
<tr>
<th align="center">Location </th><th align="center">Function </th><th align="center">Arg </th><th align="center">Type  </th></tr>
<tr>
<td align="center">L2_RAM </td><td align="center">void <em>pmsis_l2_malloc() </em></td><td align="center"><em> int size </em></td><td align="center"><em> Allocate a chunk of *size</em> bytes in L2 and returns a pointer </td></tr>
<tr>
<td align="center">L2_RAM </td><td align="center">void pmsis_l2_malloc() </td><td align="center">void *_chunk, int size </td><td align="center">Free an allocated memory chunk </td></tr>
<tr>
<td align="center">FC_TCDM </td><td align="center">void <em>pmsis_fc_tcdm_malloc() </em></td><td align="center"><em> int size </em></td><td align="center"><em> Allocate a chunk of *size</em> bytes in FC memory and returns a pointer </td></tr>
<tr>
<td align="center">FC_TCDM </td><td align="center">void pmsis_fc_tcdm_malloc_free() </td><td align="center">void <em>chunk, int size </em></td><td align="center"><em> Free an allocated memory chunk. </em></td></tr>
<tr>
<td align="center"><em> L1_TCDM </em></td><td align="center"><em> void *pmsis_l1_malloc() </em></td><td align="center"><em> int size </em></td><td align="center"><em> Allocate a chunk of *size</em> bytes in shared L1 memory and returns a pointer </td></tr>
<tr>
<td align="center">L1_TCDM </td><td align="center">void *pmsis_l1_malloc_free() </td><td align="center">void *chunk, int size </td><td align="center">Free an allocated memory chunk. </td></tr>
</table>
<p>Few notes :</p><ul>
<li>Before any call to malloc functions, it is necessary to initialize memory allocators for each memory allocations(<code>pmsis_l2_malloc_init(heapstart, size)</code> for instance, which takes an address to heap and the size of the heap). This initialization is already done by default.</li>
<li>In order to make it easier to use, a wrapper has been implemented to to allocate memory either in <code>FC_TCDM</code> or <code>L2_RAM</code> depending on available heap. This implementation is more standard like. It tries to allocate in <code>FC_TCDM</code> first then in <code>L2_RAM</code>.</li>
</ul>
<div class="fragment"><div class="line"></div><div class="line"><span class="keywordtype">void</span> *<a class="code" href="group__pmsis__malloc.html#gac2b71129653560f23d7e3f36f6e4af4a">pmsis_malloc</a>(<span class="keywordtype">size_t</span> size);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__pmsis__malloc.html#ga424a01cee4acd03b7f171df9f6e4a215">pmsis_malloc_free</a>(<span class="keywordtype">void</span> *_chunk);</div></div><!-- fragment --> <h2><a class="anchor" id="section12"></a>
UDMA usage</h2>
<p>GAP8 possess a DMA to transfer data between IO peripherals and 'L2_RAM', called <code>UDMA</code>, as you can see on the picture above. There is a limitation to the UDMA usage : the data buffer to send to peripherals or to retrieve data from peripheral can only be in <code>L2_RAM</code>. Thus if you need to send or receive data from IO peripherals, you have to use <code>pmsis_l2_malloc()</code> explicitly in order to make sure the allocated buffer is in <code>L2_RAM</code>. There is also the simpler option to have the buffer in L2 memory by declaring it as a global variable(since global variables are by default in <code>L2_RAM</code>).</p>
<h2><a class="anchor" id="section13"></a>
About stacks</h2>
<table class="doxtable">
<tr>
<th align="center">Type </th><th align="center">Size </th><th align="center">Location  </th></tr>
<tr>
<td align="center">Cluster Task Stack </td><td align="center">1KB </td><td align="center">L1_TCDM </td></tr>
<tr>
<td align="center">Main Stack </td><td align="center">4KB </td><td align="center">FC_TCDM </td></tr>
<tr>
<td align="center">ISR Stack </td><td align="center">1KB </td><td align="center">FC_TCDM </td></tr>
<tr>
<td align="center">Idle Task Stack </td><td align="center">512B </td><td align="center">L2_RAM </td></tr>
<tr>
<td align="center">FC Task Stack </td><td align="center">User choice </td><td align="center">L2_RAM </td></tr>
</table>
<p><b>Main Stack</b> refers to the stack allocated for the <code><a class="el" href="helloworld_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></code> function only. In FreeRTOS, when tasks are created and the scheduler called, there is no coming back to this function, meaning the stack can also not be accessed. If variables/objects are to be passed to tasks, consider using global variables or dynamically allocate them in L2.</p>
<p>For each created task, a memory chunk is allocated in L2_RAM, with th size depending on task's function. This is the <b>FC Task Stack</b>. When a part of the task is executed on the Cluster, then for each core enabled, 1KB memory is allocated in L1_TCDM(<b>Cluster Task Stack</b>).</p>
<h1><a class="anchor" id="section14"></a>
Kernel configuration</h1>
<p>In this release, kernel is configured as follows :</p><ul>
<li><b>configUSE_PREEMPTION</b> : Enabled. You can disable preemptive mode by adding this to the Makefile : <div class="fragment"><div class="line">NO_PREEMPTION   = true</div></div><!-- fragment --></li>
<li><b>configTICK_RATE_HZ</b> : Set to 1000. Meaning the SysTick interrupt occurs every 1ms.</li>
<li><b>configUSE_IDLE_HOOK</b> : Enabled. An associated hook function is defined to delete and exit program.</li>
<li><b>configMINIMAL_STACK_SIZE</b> : Set to 128. The size here is given in number of words, the real stack size is 128*4=512B. This macro is used to set the Idle Task's stack. If you do not use Idle Task hook function, the size can be decreased.</li>
<li><b>configUSE_TIMERS</b> : Disabled to reduce binary size. Setting this macro will enable the use of Software Timers API, but the user should also define <b>configTIMER_TASK_PRIORITY</b>, <b>configTIMER_QUEUE_LENGTH</b>, <b>configTIMER_TASK_STACK_DEPTH</b>.</li>
</ul>
<p>All the other configurations are in <em><a class="el" href="FreeRTOSConfig_8h.html">FreeRTOSConfig.h</a></em>, you can edit it to suit your application.</p>
<p>Hook functions and memory regions are defined in <em>FreeRTOS_util.c</em> and <em><a class="el" href="FreeRTOS__util_8h.html">FreeRTOS_util.h</a></em>.</p>
<p>More details and information are available in <a href="https://docs.aws.amazon.com/freertos-kernel/latest/ref/reference130.html">Amazon Reference Manual</a> and in <a href="https://www.freertos.org/a00110.html">FreeRTOS Kernel Configuration</a>.</p>
<h1><a class="anchor" id="section15"></a>
FreeRTOS API Reference</h1>
<p>Documentation and API Reference can be found on <a href="https://www.freertos.org/a00106.html">FreeRTOS API Reference</a>, <a href="https://docs.aws.amazon.com/freertos-kernel/latest/ref/welcome.html">Amazon Reference Manual</a> or <a href="https://docs.aws.amazon.com/freertos-kernel/latest/dg/about.html">Amazon Developer Guide</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Jan 24 2020 12:47:54 for  by GreenWaves Technologies
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 
	-->
	</li>
  </ul>
</div>
</body>
</html>
